var sopaOpen=function(){function W(){if(Detector.webgl)if(XMLHttpRequest){try{var a=document.createElement("canvas");var c=!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(S){c=!1}if(b=c?new THREE.WebGLRenderer({alpha:!0}):null){ja=new THREE.Scene;-1<M.indexOf("android")?(H=!0,-1<M.indexOf("firefox")||!(-1<M.indexOf("opera")||-1<M.indexOf("opr"))||(sa=!0)):-1<M.indexOf("iphone")||-1<M.indexOf("ipod")?w=H=!0:-1<M.indexOf("ipad")&&(F=H=!0);if(window.location.search){c=
window.location.search.substring(1,window.location.search.length).split("&");for(a=0;a<c.length;a++){var d=c[a].split("=");"sopa"==decodeURIComponent(d[0])?document.form0.elements.sopa.value=decodeURIComponent(d[1]):"image"==decodeURIComponent(d[0])?document.form0.elements.image.value=decodeURIComponent(d[1]):"numFiles"==decodeURIComponent(d[0])?document.form0.elements.numFiles.value=decodeURIComponent(d[1]):"numStart"==decodeURIComponent(d[0])&&(document.form0.elements.numStart.value=decodeURIComponent(d[1]))}O=
!0}this.init()}else alert("Sorry, your browser does not seem to support WebGL.\nPanoramic video is not available.\nOnly the panoramic sound may be played.")}else alert("Sorry, your browser does not seem to support XMLHttpRequest.\nPanoramic sound cannot be loaded.");else Detector.addGetWebGLMessage(),alert("Sorry, your graphic card does not seem to support WebGL.")}var A,pa=!0,ua=!0,O=!1,za=!1,va=!1,H=!1,sa=!1,ta=!1,w=!1,F=!1,X=!1,J=!1,fa=!1,ka=!1,V=!0,I=!1,P=!1,qa=!1,ca=!1,T=!1,k,q,N,da,la,ha,U,
Y,Z,l,M=navigator.userAgent.toLowerCase(),ja,x,B,aa,e,G,ia,K,ma=0,ra=0,wa=0,xa=0,D=0,a=0,c,b,g=0,f,Ba,Da,m,y=0,na=0,v=0,z=0,Aa,E,oa,Ca,ba=0,ya=0,L,C,r=0,d=0,t=0,u=2*Math.PI,Q=Math.PI/2;W.prototype.init=function(){if(O)if((k=document.form0.elements.sopa)&&0<k.value.length)f=k.value;else{alert("SOPA file is not specified!");return}else{var d=window.location.href.split(".");if("html"==d[d.length-1]){k=document.getElementById("myUrl");if(null==k){alert("Location of SOPA file is not specified!");return}f=
k.innerHTML}else"sopa"==d[d.length-1]&&(f=window.location.href)}d=f;O&&(oa=(k=document.form0.elements.numFiles)&&0<k.value.length?k.value:1);if(!O||2>oa)k=document.getElementById("numFiles"),oa=null==k?1:k.innerHTML;O&&(L=(k=document.form0.elements.numStart)&&0<k.value.length?k.value:0);if(!O||1>L)k=document.getElementById("numStart"),L=null==k?0:parseInt(k.innerHTML);k=document.getElementById("loop");qa=null==k||1==parseInt(k.innerHTML)?!1:!0;k=document.getElementById("cube");va=null==k?!1:0<parseInt(k.innerHTML)?
!0:!1;Ba=document.getElementById("hrtfUrl").innerHTML;Da=document.getElementById("phaseUrl").innerHTML;1<oa&&(d=f.substring(0,f.lastIndexOf(".")),d=10>L?d+"0"+L+".sopa":d+L+".sopa");A=new Sopa(d);A.setCardioid(y,0,0);A.loadDatabase(Ba,Da);A.loadSopaData();1<oa&&(L++,L>=oa&&(L=0));O?(k=document.form0.elements.image)&&0<k.value.length?m=k.value:(d=f.substring(0,f.lastIndexOf(".")),m=d+".mp4"):(k=document.getElementById("imgUrl"))&&0<k.innerHTML.length&&(m=k.innerHTML);var h=m.substring(m.lastIndexOf("."),
m.length);d=m;".jpg"==h&&(I=!0,V=!1,h=document.getElementById("numImage"),null==h?(Aa=1,E=0):(Aa=h.innerHTML,k=document.getElementById("jpgStart"),E=null==k?0:parseInt(k.innerHTML),0<E&&(10>E?d=m.slice(0,m.length-4)+"000"+E+".jpg":100>E?d=m.slice(0,m.length-4)+"00"+E+".jpg":1E3>E&&(d=m.slice(0,m.length-4)+"0"+E+".jpg"))),1<Aa?(h=document.getElementById("interval"),null==h?(alert("Slide interval is not defined!"),sampleInterval=22050):sampleInterval=h.innerHTML):P=!0);q=window.innerWidth;N=window.innerHeight;
document.body.style.overflow="hidden";document.body.style.position="fixed";this.getImage(d);K=new THREE.Mesh(G,ia);g++;K.position.set(0,0,0);K.rotation.order="YXZ";ja.add(K);U=.96;Y=H?.85:.8;da=q*(1-U)/2;e=new THREE.PerspectiveCamera(75,q*U/(N*Y),1,1E3);e.position.set(0,0,.1);e.lookAt({x:0,y:0,z:-1});e.rotation.order="YXZ";b.setSize(q*U,N*Y);b.setClearColor({color:0});b.domElement.style.position="relative";b.domElement.style.bottom="0px";b.domElement.style.left=da+"px";document.getElementById("stage").appendChild(b.domElement);
b.setPixelRatio(window.devicePixelRatio);b.render(ja,e);k=document.getElementById("stage");Z=k.getBoundingClientRect();ha=Z.bottom-Z.top;la=window.pageYOffset;l=document.createElement("div");l.style.position="relative";l.style.width=q;l.style.height=N/8;l.style.color="orange";l.style.fontSize="32px";l.style.bottom=H?w&&0!=window.orientation&&180!=window.orientation?N/3+20+"px":N/4+"px":N/4+"px";l.innerHTML="Loading data. Wait for a moment.<BR>Stereo headphones are necessary";l.style.left="0px";l.style.textAlign=
"center";l.style.filter="dropshadow(color=#ffff0000, offx=10, offy=10, positive=true)";document.getElementById("stage").appendChild(l);var p=document.createElement("button");p.innerHTML="OMNIDIRECTIONAL";p.style.background="rgba(255,240,192,0.75)";p.style.color="#009900";p.style.fontSize="24px";p.style.position="relative";p.style.top=F?-(N/4-50)+"px":w?0==window.orientation||180==window.orientation?-(N/4-60)+"px":-(N/2-40)+"px":H?-(N/3-60)+"px":-(N/10)+"px";p.setAttribute("align","center");p.onclick=
function(){y++;2<y&&(y=0);A.setCardioid(y,0,0);p.innerHTML=0==y?"OMNIDIRECTIONAL":1==y?"CARDIOID IS ON":"CARDIOID<sup>2</sup> IS ON"};document.getElementById("stage").appendChild(p);H&&(window.DeviceOrientationEvent?window.addEventListener("deviceorientation",this.orient,!0):alert("deviceorientation is not supported"),c=new THREE.DeviceOrientationControls(e,b.domElement),c.connect());H||window.addEventListener("mousemove",function(a){var b=Z.top-la;a.clientX<da||a.clientX>q-da?ma=ra=0:a.clientY<b||
a.clientY>Z.bottom-la?ma=ra=0:(ma=a.clientX>=q/3&&a.clientX<2*q/3?0:a.clientX<q/3?a.clientX-q/3:a.clientX-2*q/3,ra=a.clientY>=b+ha/3&&a.clientY<b+2*ha/3?0:a.clientY<b+ha/3?a.clientY-(b+ha/3):a.clientY-(b+2*ha/3))},!1);this.render();this.initVariables();b.domElement.addEventListener("click",function(){X&&(X=!1);4==z?(A.Play(),ta=!0,I||w||F||x.pause(),1<oa&&qa?(l.innerHTML=f+" was played. <BR>Good bye",z++):(l.innerHTML=H?f+" was played. <BR>Tap back button to close this window.":f+" was played. <BR>Thank you.",
z=2)):4<z?l.innerHTML="Please reload this page":2==z?(ta&&z++,I||(x.currentTime=0),l.innerHTML=H?"Tap to start<BR>Please use stereo headphones":"Click to start<BR>Please use stereo headphones"):3==z?(ya=0,l.innerHTML=H?"Tap to stop reproduction<BR>Rotate device to change panning":"Click to stop reproduction<BR>Move the mouse pointer to change panning",I||(x.currentTime=0),1<oa?A.setLastLoop(!1):A.setLastLoop(!0),(w||F)&&A.Play(),ca=!0,w||F||I||x.play()):-1==z&&sa&&(x.play(),l.innerHTML="Preparing data, wait for a while<BR>Use stereo headphones")},
!1);H&&(window.addEventListener("touchmove",function(a){a.preventDefault()},!1),b.domElement.addEventListener("touchstart",function(a){a=a.changedTouches[0];xa=parseInt(a.clientY);wa=parseInt(a.clientX)},!1),b.domElement.addEventListener("touchmove",function(b){b=b.changedTouches[0];a=parseInt(b.clientY)-xa;D=parseInt(b.clientX)-wa;xa=parseInt(b.clientY);wa=parseInt(b.clientX);-90==window.orientation&&(D*=-1)},!1))};W.prototype.orient=function(a){a.alpha||a.gamma||a.beta?ua&&(r=a.gamma*Math.PI/180,
d=a.beta*Math.PI/180,ua=!1):alert("deviceorientation not available");window.removeEventListener("deviceorientation",this.orient,!0)};W.prototype.initVariables=function(){z=v=na=0};W.prototype.getImage=function(a){if(I){0==g&&(ia=va?new THREE.MeshBasicMaterial({color:16777215,side:THREE.BackSide,overdraw:!0}):new THREE.MeshBasicMaterial({color:16777215,overdraw:!0}));T=!1;var b=new THREE.TextureLoader;b.crossOrigin="*";b.load(a,function(a){ia.map=a;ia.needsUpdate=!0},function(a){a.loaded==a.total&&
(T=!0)},function(a){alert("TextureLoader not supported!")});if(0==g)if(va){a=[new THREE.Vector2(0,.5),new THREE.Vector2(.25,.5),new THREE.Vector2(.25,1),new THREE.Vector2(0,1)];b=[new THREE.Vector2(.25,.5),new THREE.Vector2(.5,.5),new THREE.Vector2(.5,1),new THREE.Vector2(.25,1)];var c=[new THREE.Vector2(.5,.5),new THREE.Vector2(.75,.5),new THREE.Vector2(.75,1),new THREE.Vector2(.5,1)],d=[new THREE.Vector2(.75,.5),new THREE.Vector2(1,.5),new THREE.Vector2(1,1),new THREE.Vector2(.75,1)],f=[new THREE.Vector2(0,
0),new THREE.Vector2(.25,0),new THREE.Vector2(.25,.5),new THREE.Vector2(0,.5)],e=[new THREE.Vector2(.25,0),new THREE.Vector2(.5,0),new THREE.Vector2(.5,.5),new THREE.Vector2(.25,.5)];G=new THREE.CubeGeometry(10,10,10);G.faceVertexUvs[0]=[];G.faceVertexUvs[0][0]=[d[2],d[1],d[3]];G.faceVertexUvs[0][1]=[d[1],d[0],d[3]];G.faceVertexUvs[0][2]=[b[2],b[1],b[3]];G.faceVertexUvs[0][3]=[b[1],b[0],b[3]];G.faceVertexUvs[0][4]=[e[2],e[1],e[3]];G.faceVertexUvs[0][5]=[e[1],e[0],e[3]];G.faceVertexUvs[0][6]=[f[2],
f[1],f[3]];G.faceVertexUvs[0][7]=[f[1],f[0],f[3]];G.faceVertexUvs[0][8]=[a[2],a[1],a[3]];G.faceVertexUvs[0][9]=[a[1],a[0],a[3]];G.faceVertexUvs[0][10]=[c[2],c[1],c[3]];G.faceVertexUvs[0][11]=[c[1],c[0],c[3]]}else G=new THREE.SphereGeometry(10,12,12),G.scale(-1,1,1)}else G=new THREE.SphereGeometry(10,12,12),G.scale(-1,1,1),x=document.createElement("video"),x.style.visibility="true",x.width=960,x.height=480,x.loop=qa?!0:!1,x.muted=!0,x.src=a,x.setAttribute("crossorigin","anonymous"),x.load(),B=document.createElement("canvas"),
B.width=960,B.height=480,videoImageContext=B.getContext("2d"),videoImageContext.textAlign="center",videoImageContext.fillStyle="#00ff00",videoImageContext.fillRect(0,0,B.width,B.height),w||F?(x.autoplay=!1,x.setAttribute("webkit-playsinline","webkit-playsinline"),x.currentTime=0,videoImageContext.drawImage(x,0,0,B.width,B.height),aa=new THREE.VideoTexture(B),aa.format=THREE.RGBFormat):aa=new THREE.VideoTexture(x),aa.minFilter=THREE.LinearFilter,aa.magFilter=THREE.LinearFilter,aa.generateMipmaps=!1,
ia=new THREE.MeshBasicMaterial({map:aa,overdraw:!0})};W.prototype.render=function(){var g=this;var h=A.currentOffset();var p=A.totalOffset();ya+=p-ba;ba=p;window.addEventListener("resize",function(){g.onWindowResize()},!1);window.addEventListener("scroll",function(){g.onWindowScroll()},!1);if(I||x){if(ca){ca=!1;if(I||!x.paused)w||F||A.Play();z++}h<Ca&&(1<oa?(p=f.substring(0,f.lastIndexOf(".")),p=10>L?p+"0"+L+".sopa":""+p+L+".sopa",A.setUrl(p),A.loadSopaData(),1==L?(ya=h,I||(x.currentTime=h/C)):0==
L&&(qa||A.setLastLoop(!0)),L++,L>=oa&&(L=0)):ya=h);Ca=h;if(I)!P&&(h=parseInt(ya/sampleInterval),h==E+1||h<E)&&(E=h,E>=Aa&&(E=0),T&&(h=0==E?m:10>E?m.substring(0,m.length-4)+"000"+E+".jpg":100>E?m.substring(0,m.length-4)+"00"+E+".jpg":1E3>E?m.substring(0,m.length-4)+"0"+E+".jpg":m,g.getImage(h)));else if(V)x.readyState===x.HAVE_ENOUGH_DATA&&(V=!1);else{sa&&-1==z&&0<x.currentTime&&(x.pause(),z=3,l.innerHTML="Tap to start<BR>Please use stereo headphones");if(w||F)x.currentTime=ya/C,videoImageContext.drawImage(x,
0,0,B.width,B.height);aa&&(aa.needsUpdate=!0)}requestAnimationFrame(function(){g.render()});H?(c.update(),pa&&(K.rotateY(-e.rotation.y),w||F?-90==window.orientation?J=!0:180==window.orientation?(ka=!0,alert("Device orientation not supported!\nChange the device orientation and try again."),K.rotateY(Math.PI)):0==window.orientation&&(fa=!0,K.rotateY(Math.PI)):(h=screen.orientation||screen.mozOrientation||screen.msOrientation,"landscape-secondary"==h.type?J=!0:"portrait-secondary"==h.type?(ka=!0,K.rotateY(Q)):
"portrait-primary"==h.type&&(K.rotateY(-Q),fa=!0)),pa=!1),J?(h=e.rotation.y+Q,e.rotation.x+=r):ka?(h=w||F?e.rotation.y:e.rotation.y+Q,e.rotation.x-=d):fa?(h=w||F?e.rotation.y-Math.PI:e.rotation.y+Q,e.rotation.x+=d):(h=e.rotation.y-Q,e.rotation.x-=r),e.rotation.x>Q?e.rotation.x=Q:e.rotation.x<-Q&&(e.rotation.x=-Q),J?(r+=a*Math.PI/(2*q),r>=Math.PI?r-=u:r<-Math.PI&&(r+=u),K.rotateY(D*Math.PI/(2*q)),t-=D*Math.PI/(2*q),t<-Math.PI?t+=u:t>=Math.PI&&(t-=u)):fa?(d+=a*Math.PI/(2*q),d>=Math.PI?d-=u:d<-Math.PI&&
(d+=u),K.rotateY(-D*Math.PI/(2*q)),t+=D*Math.PI/(2*q),t>=Math.PI?t-=u:t<-Math.PI&&(t+=u)):ka?(d-=a*Math.PI/(2*q),d<-Math.PI?d+=u:d>=Math.PI&&(d-=u),K.rotateY(-D*Math.PI/(2*q)),t+=D*Math.PI/(2*q),t<-Math.PI?t+=u:t>=Math.PI&&(t-=u)):(r-=a*Math.PI/(2*q),r<-Math.PI?r+=u:r>=Math.PI&&(r-=u),K.rotateY(-D*Math.PI/(2*q)),t+=D*Math.PI/(2*q),t>=Math.PI?t-=u:t<-Math.PI&&(t+=u)),D=a=0,e.rotation.z=0):(pa&&(e.rotation.y+=Math.PI,pa=!1),e.rotation.y-=2E-5*ma,e.rotation.x=e.rotation.x<=Math.PI/3&&e.rotation.x>=-Math.PI/
3?e.rotation.x-2E-5*ra:e.rotation.x>Math.PI/3?Math.PI/3:-Math.PI/3,e.rotation.y>=u?e.rotation.y-=u:0>e.rotation.y&&(e.rotation.y+=u),h=e.rotation.y);h+=t;p=e.rotation.x;0>h?h+=u:h>=u&&(h-=u);h=180*h/Math.PI;h-=180;p=180*p/Math.PI;var k=Math.abs(na-parseInt(h));3<k&&(na=parseInt(h),A.setPan(na),H||(X=!0));k=Math.abs(v-parseInt(p));3<k&&180>k&&(v=parseInt(p),A.setTilt(v),H||(X=!0));g.interv();b.render(ja,e)}};W.prototype.onWindowResize=function(){e.aspect=window.innerWidth*U/(window.innerHeight*Y);
e.updateProjectionMatrix();b.setPixelRatio(window.devicePixelRatio);b.setSize(window.innerWidth*U,window.innerHeight*Y);q=window.innerWidth;N=window.innerHeight;da=q*(1-U)/2;k=document.getElementById("stage");Z=k.getBoundingClientRect();ha=Z.bottom-Z.top};W.prototype.onWindowScroll=function(){la=window.pageYOffset};W.prototype.interv=function(){4!=z||A.beingPlayed()?0<A.fftWinSize()&&A.databaseReady()&&!za&&!V&&(za=!0,z=3,A.setup()&&(H&&sa&&!ta&&!I?(z=-1,l.innerHTML="Tap screen<BR>Please use stereo headphones",
x.currentTime=0):l.innerHTML=H?"Tap to start<BR>Please use stereo headphones":"Click to start<BR>Please use stereo headphones",Ca=C=A.getSampleRate())):(I&&qa?(l.innerHTML=f+" was played. <BR>Good bye",z++):(l.innerHTML=H?f+" was played. <BR>Tap back button to close this window.":f+" was played. <BR>Thank you.",z=2),ta=!0)};return W}();window.onload=function(){new sopaOpen};
Sopa=function(W){this.urlStr=W;var A=navigator.userAgent.toLowerCase(),pa=!1,ua=!1,O=!1,za=!1,va=!0,H=0,sa,ta,w=new XMLHttpRequest,F=new XMLHttpRequest,X=new Int16Array(130048),J=new Int16Array(130048),fa,ka,V,I,P,qa=0,ca,T=0,k,q=0,N=0,da=0,la=0,ha,U,Y,Z,l,M,ja,x,B=0,aa=36,e=18,G,ia=Array(256),K=[],ma=[0,0,-1],ra=0,wa=new Float32Array(2229),xa=new Float32Array(2229),D=Math.PI/2;this.setup=function(){-1<A.indexOf("iphone")||-1<A.indexOf("ipod")||-1<A.indexOf("ipad")?O=!0:A.indexOf("android");try{Z=
window.AudioContext||window.webkitAudioContext,l=new Z,this.unlockAudioContext(l)}catch(Ba){return alert("Web Audio API is not supported in this browser"),!1}ja=l.sampleRate;if(0==T)return alert("SOPA data not available!"),!1;x=ja/T;aa=36;e=18;q=4096;ca=0;G=new Float32Array(B);var a=B/3;for(var c=0;c<B;c++)G[c]=c<a?(.54-.46*Math.cos(Math.PI*c/a))/2:c>=B-a?(.54-.46*Math.cos(Math.PI*(B-c)/a))/2:.5;for(a=0;254>a;a++)K[a]=this.initCoord(a);for(c=0;256>c;c++){ia[c]=Array(72);for(var b=0;72>b;b++){ia[c][b]=
Array(36);a=36<=b?Math.PI*(b-36)/36:-Math.PI*(36-b)/36;for(var g=-18;18>g;g++){var f=Math.PI*g/36;f=this.modifySector(c,a,f);ia[c][b][g+18]=Math.floor(f)}}}M=l.createScriptProcessor(q,2,2);return!0};this.unlockAudioContext=function(a){function c(){a.resume().then(b)}function b(){f.forEach(function(a){return g.removeEventListener(a,c)})}if("suspended"===a.state){var g=document.body,f=["touchstart","touchend","mousedown","keydown"];f.forEach(function(a){return g.addEventListener(a,c,!1)})}};this.loadDatabase=
function(a,c){sa=a;ta=c;w.open("GET",sa,!0);w.responseType="arraybuffer";w.onreadystatechange=this.handleHrtf;w.send(null);F.open("GET",ta,!0);F.responseType="arraybuffer";F.onreadystatechange=this.handlePhase;F.send(null)};Sopa.prototype.handleHrtf=function(){4==w.readyState&&200==w.status&&(X=new Int16Array(w.response),ra++,1<ra&&(ua=!0))};Sopa.prototype.handlePhase=function(){4==F.readyState&&200==F.status&&(J=new Int16Array(F.response),ra++,1<ra&&(ua=!0))};this.loadSopaData=function(){this.loadSopa(this.handleSopa)};
Sopa.prototype.loadSopa=function(a){var c=this,b=new XMLHttpRequest;b.open("GET",this.urlStr,!0);b.responseType="arraybuffer";b.onreadystatechange=function(){4==b.readyState&&(200!=b.status&&4==b.readyState?alert("HTTP error "+b.status):a.call(c,b))};b.send(null)};Sopa.prototype.handleSopa=function(a){a=a.response;var c=((new DataView(a)).byteLength-44)/4;P=new Uint8Array(a,0,44);0==qa?(fa=new Uint8Array(a,44,4*c),V=new Int16Array(a,44,2*c)):(ka=new Uint8Array(a,44,4*c),I=new Int16Array(a,44,2*c));
0==la&&(va=this.checkHeader()?!0:!1);qa=0==qa?1:0};Sopa.prototype.checkHeader=function(){var a=new Uint8Array(4);for(c=8;12>c;c++)a[c-8]=P[c];if(83!=a[0]||79!=a[1]||80!=a[2]||65!=a[3])return alert("Data format error!"),!1;for(c=12;15>c;c++)a[c-12]=P[c];if(102!=a[0]||109!=a[1]||116!=a[2])return alert("Data format error!"),!1;if(16!=P[16])return alert("PCM data should be 16-bit depth!"),!1;T=P[25]&255;T*=256;T+=P[24]&255;if(22050!=T&&44100!=T)return alert("Wrong sampleRate! "+T),!1;k=P[39];if(2>k)return alert("Sorry, this version is not supported"),
!1;if(0==B){for(var c=5;255!=fa[c]&&4096>=c;)c+=4;B=c-1;if(4096<B)return alert("Something wrong!"),!1;U=new Float32Array(B);Y=new Float32Array(B)}return!0};this.fftWinSize=function(){return va?B:0};this.databaseReady=function(){return ua};this.beingPlayed=function(){return pa};this.Play=function(){this.play()};this.currentOffset=function(){return N};this.totalOffset=function(){return la};this.getSampleRate=function(){return T};this.setLastLoop=function(a){za=a};this.setUrl=function(a){this.urlStr=
a};this.setPan=function(a){179<a?a=179:-180>a&&(a=-180);aa=Math.floor(36+a/5)};this.setTilt=function(a){89<a?a=89:-90>a&&(a=-90);e=Math.floor(18+a/5)};this.setCardioid=function(a,c,b){H=a;focus=void 0==c?-Math.PI:c-Math.PI;void 0==b&&(b=0);ma[0]=Math.sin(focus);ma[1]=Math.sin(b);ma[2]=Math.cos(focus)};Sopa.prototype.play=function(){var a=this;pa?(M.disconnect(l.destination),M.onaudioprocess=null,pa=!1):(ha=ca=currenttime=N=da=la=0,M.onaudioprocess=function(c){a.Process.call(a,c)},O&&l.createBufferSource().start(0),
pa=!0,M.connect(l.destination))};Sopa.prototype.Process=function(a){var c=B,b=2*B,g=c/2,f=c/2,l=1/ja,A=44100*c/(512*T),m,y,na=0,v=Array(2),z=new Float32Array(c),w=new Float32Array(c),E=new Float32Array(c),F=new Float32Array(c),K=a.outputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(1);var ba=ha-da,M=wa.subarray(0,ba);K.set(M,0);M=xa.subarray(0,ba);a.set(M,0);da+=ba;currenttime=da/ja;M=Math.ceil((q-ba)/(x*g));for(var L=0;L<M;L++){var C=2*N;if(0==ca)if(C+b>V.length){var r=V.subarray(C,V.length);
var d=null!=I?I.subarray(0,C+b-V.length):V.subarray(0,C+b-V.length);var t=new Int16Array(r.length+d.length);t.set(r);t.set(d,r.length)}else t=V.subarray(C,C+b);else C+b>I.length?(r=I.subarray(C,I.length),d=V.subarray(0,C+b-I.length),t=new Int16Array(r.length+d.length),t.set(r),t.set(d,r.length)):t=I.subarray(C,C+b);r=new Float32Array(B);var u=new Float32Array(B);for(d=0;d<B;d++)r[d]=t[2*d+1];d={real:r,image:u};this.fastFt(d,!1);t=2*C;var Q=t+c;w[f]=r[f]*Math.cos(u[f]);z[f]=r[f]*Math.cos(u[f]);F[f]=
r[f]*Math.sin(u[f]);E[f]=r[f]*Math.sin(u[f]);for(d=0;d<f;d++){C=c-d;var R=Math.floor(d/A);var h=0==R?R:512-R;var p=0==ca?0==d%2?fa[t+2*d+1]:fa[t+2*(d-1)]:0==d%2?ka[t+2*d+1]:ka[t+2*(d-1)];var S=3>k?p:0==ca?0==d%2?fa[Q+2*d+1]:fa[Q+2*(d-1)]:0==d%2?ka[Q+2*d+1]:ka[Q+2*(d-1)];if(0==R){if(S=R=r[d],h=p=u[d],0<d){var D=m=r[C];var ea=y=u[C]}}else if(254<=p&&254<=S)S=R=r[d],h=p=u[d],D=m=r[C],ea=y=u[C];else{253<p?p=S:253<S&&(S=p);if(0<=p&&256>p){p=ia[p][aa][e];var W=this.opposit(p);S=ia[S][aa][e];var Z=this.opposit(S);
0<H?(m=this.initCoord(p),y=this.initCoord(S),v[0]=this.weight(ma,m),v[1]=this.weight(ma,y)):v[0]=v[1]=1;na=0;v[0]/=2048;v[1]/=2048}D=512*p+R;ea=512*p+h;var n=X[D]*v[0];var O=512*S+R;var P=512*S+h;n+=X[O]*v[1];n/=2;S=r[d]*n;n=J[D]/1E4;n+=J[O]/1E4;n/=2;31416<Math.abs(J[D]-J[O])&&(n=0>n?n+Math.PI:n-Math.PI);p=u[d]+n+na;n=X[ea]*v[0];n+=X[P]*v[1];n/=2;m=r[C]*n;n=J[ea]/1E4;n+=J[P]/1E4;n/=2;31416<Math.abs(J[ea]-J[P])&&(n=0>n?n+Math.PI:n-Math.PI);y=u[C]+n-na;D=512*W+R;ea=512*W+h;n=X[D]*v[0];O=512*Z+R;P=512*
Z+h;n+=X[O]*v[1];n/=2;R=r[d]*n;n=J[D]/1E4;n+=J[O]/1E4;n/=2;31416<Math.abs(J[D]-J[O])&&(n=0>n?n+Math.PI:n-Math.PI);h=u[d]+n+na;n=X[ea]*v[0];n+=X[P]*v[1];n/=2;D=r[C]*n;n=J[ea]/1E4;n+=J[P]/1E4;n/=2;31416<Math.abs(J[ea]-J[P])&&(n=0>n?n+Math.PI:n-Math.PI);ea=u[C]+n-na}w[d]=R*Math.cos(h);z[d]=S*Math.cos(p);F[d]=R*Math.sin(h);E[d]=S*Math.sin(p);0<d&&(w[C]=D*Math.cos(ea),z[C]=m*Math.cos(y),F[C]=D*Math.sin(ea),E[C]=m*Math.sin(y))}d={real:w,image:F};this.fastFt(d,!0);d={real:z,image:E};this.fastFt(d,!0);for(d=
0;d<c;d++)w[d]*=G[d],z[d]*=G[d],U[d]+=w[d],Y[d]+=z[d];for(d=0;d<g;d++){r=U[d+1]/32768;u=Y[d+1]/32768;C=U[d]/32768;t=Y[d]/32768;for(Q=la/T;currenttime<Q;)h=(Q-currenttime)*T,R=C*h+r*(1-h),h=t*h+u*(1-h),ba<q?(K[ba]=R,a[ba]=h,da++,currenttime=da/ja):(wa[ba-q]=R,xa[ba-q]=h,currenttime+=l),ba++,ha++;la++}d=U.subarray(g);U=new Float32Array(B);U.set(d,0);d=Y.subarray(g);Y=new Float32Array(B);Y.set(d,0);N+g>=(0==ca?V.length/2:I.length/2)?za?(L=M,this.play()):(N=0,ca=0==ca&&I?1:0):N+=g}};Sopa.prototype.fastFt=
function(a,c){var b,g,f,e,k=B;var m=2*Math.PI;var y=a.real,l=a.image;if(!c)for(b=0;b<k;b++){l[b]=0;var v=(1-Math.cos(m*b/k))/2;y[b]*=v}b=Math.PI;for(m=v=0;m<k-1;m++){if(m<=v){var z=y[m];y[m]=y[v];y[v]=z;z=l[m];l[m]=l[v];l[v]=z}for(g=k/2;g<=v;)v-=g,g/=2;v+=g}var q=1;for(v=c?1:-1;q<=k/2;){var x=Math.cos(b);var A=Math.sin(v*b);m=1;for(f=g=0;f<q;f++){for(e=f;e<k;e+=2*q){var w=e+q;z=y[w]*m-l[w]*g;var D=l[w]*m+y[w]*g;y[w]=y[e]-z;l[w]=l[e]-D;y[e]+=z;l[e]+=D}z=x*m-A*g;g=A*m+x*g;m=z}q*=2;b/=2}if(!c)for(b=
0;b<k;b++)y[b]/=k,l[b]/=k,v=Math.sqrt(y[b]*y[b]+l[b]*l[b]),m=Math.atan2(l[b],y[b]),y[b]=v,l[b]=m};Sopa.prototype.initCoord=function(a){var c=Array(3),b=Math.PI/12;127<=a&&(b*=-1);if(0==a)c[0]=c[2]=0,c[1]=1;else if(253==a)c[0]=c[2]=0,c[1]=-1;else{if(9>a||245<=a){var g=Math.PI/4;var f=Math.cos(5*b);c[1]=Math.sin(5*b);a=9>a?g*(a-1)-Math.PI:g*(252-a)}else 25>a||229<=a?(g=Math.PI/8,f=Math.cos(4*b),c[1]=Math.sin(4*b),a=25>a?g*(a-9)-Math.PI:g*(244-a)):49>a||205<=a?(g=Math.PI/12,f=Math.cos(3*b),c[1]=Math.sin(3*
b),a=49>a?g*(a-25)-Math.PI:g*(228-a)):79>a||175<=a?(g=Math.PI/15,f=Math.cos(2*b),c[1]=Math.sin(2*b),a=79>a?g*(a-49)-Math.PI:g*(204-a)):111>a||143<=a?(g=Math.PI/16,f=Math.cos(b),c[1]=Math.sin(b),a=111>a?g*(a-79)-Math.PI:g*(174-a)):(g=Math.PI/16,f=1,c[1]=0,a=127>a?g*(a-111)-Math.PI:g*(142-a));c[0]=f*Math.sin(a);c[2]=f*Math.cos(a)}return c};Sopa.prototype.opposit=function(a){return 0==a||253<=a?a:9>a?1==a?a:10-a:25>a?9==a?a:34-a:49>a?25==a?a:74-a:79>a?49==a?a:128-a:111>a?79==a?a:190-a:127>a?111==a?a:
15+a:143>a?142==a?a:a-15:175>a?174==a?a:316-a:205>a?204==a?a:378-a:229>a?228==a?a:432-a:245>a?244==a?a:472-a:252==a?a:496-a};Sopa.prototype.modifySector=function(a,c,b){var g=0;if(253<a)return a;0!=a&&253!=a&&(g=Math.atan2(K[a][0],K[a][2])+c);var f=0==a||253==a?0:9>a||245<=a?Math.cos(5*Math.PI/12):25>a||229<=a?Math.cos(Math.PI/3):49>a||205<=a?Math.cos(Math.PI/4):79>a||175<=a?Math.cos(Math.PI/6):111>a||143<=a?Math.cos(Math.PI/12):1;c=[];c[0]=f*Math.sin(g);c[2]=f*Math.cos(g);c[1]=K[a][1];if(0!=b){f=
c[0];a=c[1];var e=c[2];f=Math.sqrt(f*f+e*e);b=Math.atan2(a,f)+b;a=Math.sqrt(f*f+a*a);c[0]=a*Math.cos(b)*Math.sin(g);c[2]=a*Math.cos(b)*Math.cos(g);c[1]=a*Math.sin(b)}return this.calcSector(c)};Sopa.prototype.calcSector=function(a){var c=2*Math.PI;if(a[1]>=Math.sin(11*Math.PI/24))return 0;if(a[1]<=-Math.sin(11*Math.PI/24))return 253;var b=Math.atan2(-a[0],-a[2]);a[1]>=Math.sin(3*Math.PI/8)?(0>b&&(b+=c),a=1+b/(Math.PI/4)):a[1]<=-Math.sin(3*Math.PI/8)?a=249-b/(Math.PI/4):a[1]>=Math.sin(7*Math.PI/24)?
(0>b&&(b+=c),a=9+b/(Math.PI/8)):a[1]<=-Math.sin(7*Math.PI/24)?a=237-b/(Math.PI/8):a[1]>=Math.sin(5*Math.PI/24)?(0>b&&(b+=c),a=25+b/(Math.PI/12)):a[1]<=-Math.sin(5*Math.PI/24)?a=217-b/(Math.PI/12):a[1]>=Math.sin(Math.PI/8)?(0>b&&(b+=c),a=49+b/(Math.PI/15)):a[1]<=-Math.sin(Math.PI/8)?a=190-b/(Math.PI/15):a[1]>=Math.sin(Math.PI/24)?(0>b&&(b+=c),a=79+b/(Math.PI/16)):a=a[1]<=-Math.sin(Math.PI/24)?159-b/(Math.PI/16):0>b?127-b/(Math.PI/16):b==Math.PI?142:111+b/(Math.PI/16);return a};Sopa.prototype.weight=
function(a,c){var b=a[0]*c[0]+a[1]*c[1]+a[2]*c[2];var g=(1+b)/2;if(1<H&&(g*=b,2<H)){var e=Math.sin(Math.PI*b/3+Math.PI/6);e*=2*-Math.cos(Math.PI*b/3+Math.PI/3);g*=e}return g};Sopa.prototype.getUnitVector=function(a,c){var b=[a[0]+c[0],a[1]+c[1],a[2]+c[2]];var e=a[0]*c[0]+a[1]*c[1]+a[2]*c[2];1<e?b.push(0):-1>e?b.push(D):b.push(Math.acos(e)/2);e=Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]);0<e?(b[0]/=e,b[1]/=e,b[2]/=e):(b[0]=0,b[1]=1,b[2]=0);return b}};