var sopaOpen=function(){function H(){if(Detector.webgl)if(XMLHttpRequest){try{var a=document.createElement("canvas");var b=!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(Ca){b=!1}if(f=b?new THREE.WebGLRenderer({alpha:!0}):null){ka=new THREE.Scene;-1<R.indexOf("android")?(J=!0,-1<R.indexOf("firefox")||!(-1<R.indexOf("opera")||-1<R.indexOf("opr"))||(qa=!0)):-1<R.indexOf("iphone")||-1<R.indexOf("ipod")?w=J=!0:-1<R.indexOf("ipad")&&(r=J=!0);if(window.location.search){b=
window.location.search.substring(1,window.location.search.length).split("&");for(a=0;a<b.length;a++){var c=b[a].split("=");"sopa"==decodeURIComponent(c[0])?document.form0.elements.sopa.value=decodeURIComponent(c[1]):"image"==decodeURIComponent(c[0])?document.form0.elements.image.value=decodeURIComponent(c[1]):"numFiles"==decodeURIComponent(c[0])?document.form0.elements.numFiles.value=decodeURIComponent(c[1]):"numStart"==decodeURIComponent(c[0])&&(document.form0.elements.numStart.value=decodeURIComponent(c[1]))}O=
!0}this.init()}else alert("Sorry, your browser does not seem to support WebGL.\nPanoramic video is not available.\nOnly the panoramic sound may be played.")}else alert("Sorry, your browser does not seem to support XMLHttpRequest.\nPanoramic sound cannot be loaded.");else Detector.addGetWebGLMessage(),alert("Sorry, your graphic card does not seem to support WebGL.")}var x,S=!0,sa=!0,O=!1,xa=!1,ta=!1,J=!1,qa=!1,ra=!1,w=!1,r=!1,Z=!1,K=!1,ia=!1,la=!1,X=!0,I=!1,P=!1,oa=!1,ca=!1,V=!1,g,q,M,da,ma,ja,W,aa,
T,k,R=navigator.userAgent.toLowerCase(),ka,m,y,N,e,G,Y,D,na=0,pa=0,ua=0,va=0,a=0,c=0,b,f,L=0,U,Aa,ea,l,v=0,fa=0,ga=0,z=0,ya,C,ba,za,Ba=0,wa=0,p,E,d=0,A=0,u=0,B=2*Math.PI,F=Math.PI/2;H.prototype.init=function(){if(O)if((g=document.form0.elements.sopa)&&0<g.value.length)U=g.value;else{alert("SOPA file is not specified!");return}else{var d=window.location.href.split(".");if("html"==d[d.length-1]){g=document.getElementById("myUrl");if(null==g){alert("Location of SOPA file is not specified!");return}U=
g.innerHTML}else"sopa"==d[d.length-1]&&(U=window.location.href)}d=U;O&&(ba=(g=document.form0.elements.numFiles)&&0<g.value.length?g.value:1);if(!O||2>ba)g=document.getElementById("numFiles"),ba=null==g?1:g.innerHTML;O&&(p=(g=document.form0.elements.numStart)&&0<g.value.length?g.value:0);if(!O||1>p)g=document.getElementById("numStart"),p=null==g?0:parseInt(g.innerHTML);g=document.getElementById("loop");oa=null==g||1==parseInt(g.innerHTML)?!1:!0;g=document.getElementById("cube");ta=null==g?!1:0<parseInt(g.innerHTML)?
!0:!1;Aa=document.getElementById("hrtfUrl").innerHTML;ea=document.getElementById("phaseUrl").innerHTML;1<ba&&(d=U.substring(0,U.lastIndexOf(".")),d=10>p?d+"0"+p+".sopa":d+p+".sopa");x=new Sopa(d);x.setCardioid(v,0,0);x.loadDatabase(Aa,ea);x.loadSopaData();1<ba&&(p++,p>=ba&&(p=0));O?(g=document.form0.elements.image)&&0<g.value.length?l=g.value:(d=U.substring(0,U.lastIndexOf(".")),l=d+".mp4"):(g=document.getElementById("imgUrl"))&&0<g.innerHTML.length&&(l=g.innerHTML);var h=l.substring(l.lastIndexOf("."),
l.length);".mp4"!=h||this.fileExists(l)||(d=l.substring(0,l.lastIndexOf(".")),l=d+".jpg",h=".jpg");d=l;".jpg"==h&&(I=!0,X=!1,h=document.getElementById("numImage"),null==h?(ya=1,C=0):(ya=h.innerHTML,g=document.getElementById("jpgStart"),C=null==g?0:parseInt(g.innerHTML),0<C&&(10>C?d=l.slice(0,l.length-4)+"000"+C+".jpg":100>C?d=l.slice(0,l.length-4)+"00"+C+".jpg":1E3>C&&(d=l.slice(0,l.length-4)+"0"+C+".jpg"))),1<ya?(h=document.getElementById("interval"),null==h?(alert("Slide interval is not defined!"),
sampleInterval=22050):sampleInterval=h.innerHTML):P=!0);q=window.innerWidth;M=window.innerHeight;document.body.style.overflow="hidden";document.body.style.position="fixed";this.getImage(d);D=new THREE.Mesh(G,Y);L++;D.position.set(0,0,0);D.rotation.order="YXZ";ka.add(D);W=.96;aa=J?.85:.8;da=q*(1-W)/2;e=new THREE.PerspectiveCamera(75,q*W/(M*aa),1,1E3);e.position.set(0,0,.1);e.lookAt({x:0,y:0,z:-1});e.rotation.order="YXZ";f.setSize(q*W,M*aa);f.setClearColor({color:0});f.domElement.style.position="relative";
f.domElement.style.bottom="0px";f.domElement.style.left=da+"px";document.getElementById("stage").appendChild(f.domElement);f.setPixelRatio(window.devicePixelRatio);f.render(ka,e);g=document.getElementById("stage");T=g.getBoundingClientRect();ja=T.bottom-T.top;ma=window.pageYOffset;k=document.createElement("div");k.style.position="relative";k.style.width=q;k.style.height=M/8;k.style.color="orange";k.style.fontSize="32px";k.style.bottom=J?w&&0!=window.orientation&&180!=window.orientation?M/3+20+"px":
M/4+"px":M/4+"px";k.innerHTML="Loading data. Wait for a moment.<BR>Stereo headphones are necessary";k.style.left="0px";k.style.textAlign="center";k.style.filter="dropshadow(color=#ffff0000, offx=10, offy=10, positive=true)";document.getElementById("stage").appendChild(k);var t=document.createElement("button");t.innerHTML="OMNIDIRECTIONAL";t.style.background="rgba(255,240,192,0.75)";t.style.color="#009900";t.style.fontSize="24px";t.style.position="relative";t.style.top=r?-(M/4-50)+"px":w?0==window.orientation||
180==window.orientation?-(M/4-60)+"px":-(M/2-40)+"px":J?-(M/3-60)+"px":-(M/10)+"px";t.setAttribute("align","center");t.onclick=function(){v++;2<v&&(v=0);x.setCardioid(v,0,0);t.innerHTML=0==v?"OMNIDIRECTIONAL":1==v?"CARDIOID IS ON":"CARDIOID<sup>2</sup> IS ON"};document.getElementById("stage").appendChild(t);J&&(window.DeviceOrientationEvent?window.addEventListener("deviceorientation",this.orient,!0):alert("deviceorientation is not supported"),b=new THREE.DeviceOrientationControls(e,f.domElement),
b.connect());J||window.addEventListener("mousemove",function(a){var b=T.top-ma;a.clientX<da||a.clientX>q-da?na=pa=0:a.clientY<b||a.clientY>T.bottom-ma?na=pa=0:(na=a.clientX>=q/3&&a.clientX<2*q/3?0:a.clientX<q/3?a.clientX-q/3:a.clientX-2*q/3,pa=a.clientY>=b+ja/3&&a.clientY<b+2*ja/3?0:a.clientY<b+ja/3?a.clientY-(b+ja/3):a.clientY-(b+2*ja/3))},!1);this.render();this.initVariables();f.domElement.addEventListener("click",function(){Z&&(Z=!1);4==z?(x.Play(),ra=!0,I||w||r||m.pause(),1<ba&&oa?(k.innerHTML=
U+" was played. <BR>Good bye",z++):(k.innerHTML=J?U+" was played. <BR>Tap back button to close this window.":U+" was played. <BR>Thank you.",z=2)):4<z?k.innerHTML="Please reload this page":2==z?(ra&&z++,I||(m.currentTime=0),k.innerHTML=J?"Tap to start<BR>Please use stereo headphones":"Click to start<BR>Please use stereo headphones"):3==z?(wa=0,k.innerHTML=J?"Tap to stop reproduction<BR>Rotate device to change panning":"Click to stop reproduction<BR>Move the mouse pointer to change panning",I||(m.currentTime=
0),1<ba?x.setLastLoop(!1):x.setLastLoop(!0),(w||r)&&x.Play(),ca=!0,w||r||I||m.play()):-1==z&&qa&&(m.play(),k.innerHTML="Preparing data, wait for a while<BR>Use stereo headphones")},!1);J&&(window.addEventListener("touchmove",function(a){a.preventDefault()},!1),f.domElement.addEventListener("touchstart",function(a){a=a.changedTouches[0];va=parseInt(a.clientY);ua=parseInt(a.clientX)},!1),f.domElement.addEventListener("touchmove",function(b){b=b.changedTouches[0];c=parseInt(b.clientY)-va;a=parseInt(b.clientX)-
ua;va=parseInt(b.clientY);ua=parseInt(b.clientX);-90==window.orientation&&(a*=-1)},!1))};H.prototype.orient=function(a){a.alpha||a.gamma||a.beta?sa&&(d=a.gamma*Math.PI/180,A=a.beta*Math.PI/180,sa=!1):alert("deviceorientation not available");window.removeEventListener("deviceorientation",this.orient,!0)};H.prototype.initVariables=function(){z=ga=fa=0};H.prototype.fileExists=function(a){if(a){var b=new XMLHttpRequest;b.open("GET",a,!1);b.send();if(404==b.status)return!1;if(200==b.status)return!0}else return!1};
H.prototype.getImage=function(a){if(I){0==L&&(Y=ta?new THREE.MeshBasicMaterial({color:16777215,side:THREE.BackSide,overdraw:!0}):new THREE.MeshBasicMaterial({color:16777215,overdraw:!0}));V=!1;var b=new THREE.TextureLoader;b.crossOrigin="*";b.load(a,function(a){Y.map=a;Y.needsUpdate=!0},function(a){a.loaded==a.total&&(V=!0)},function(a){alert("TextureLoader not supported!")});if(0==L)if(ta){a=[new THREE.Vector2(0,.5),new THREE.Vector2(.25,.5),new THREE.Vector2(.25,1),new THREE.Vector2(0,1)];var b=
[new THREE.Vector2(.25,.5),new THREE.Vector2(.5,.5),new THREE.Vector2(.5,1),new THREE.Vector2(.25,1)],c=[new THREE.Vector2(.5,.5),new THREE.Vector2(.75,.5),new THREE.Vector2(.75,1),new THREE.Vector2(.5,1)],d=[new THREE.Vector2(.75,.5),new THREE.Vector2(1,.5),new THREE.Vector2(1,1),new THREE.Vector2(.75,1)],f=[new THREE.Vector2(0,0),new THREE.Vector2(.25,0),new THREE.Vector2(.25,.5),new THREE.Vector2(0,.5)],e=[new THREE.Vector2(.25,0),new THREE.Vector2(.5,0),new THREE.Vector2(.5,.5),new THREE.Vector2(.25,
.5)];G=new THREE.CubeGeometry(10,10,10);G.faceVertexUvs[0]=[];G.faceVertexUvs[0][0]=[d[2],d[1],d[3]];G.faceVertexUvs[0][1]=[d[1],d[0],d[3]];G.faceVertexUvs[0][2]=[b[2],b[1],b[3]];G.faceVertexUvs[0][3]=[b[1],b[0],b[3]];G.faceVertexUvs[0][4]=[e[2],e[1],e[3]];G.faceVertexUvs[0][5]=[e[1],e[0],e[3]];G.faceVertexUvs[0][6]=[f[2],f[1],f[3]];G.faceVertexUvs[0][7]=[f[1],f[0],f[3]];G.faceVertexUvs[0][8]=[a[2],a[1],a[3]];G.faceVertexUvs[0][9]=[a[1],a[0],a[3]];G.faceVertexUvs[0][10]=[c[2],c[1],c[3]];G.faceVertexUvs[0][11]=
[c[1],c[0],c[3]]}else G=new THREE.SphereGeometry(10,12,12),G.scale(-1,1,1)}else G=new THREE.SphereGeometry(10,12,12),G.scale(-1,1,1),m=document.createElement("video"),m.style.visibility="true",m.width=960,m.height=480,m.loop=oa?!0:!1,m.muted=!0,m.src=a,m.setAttribute("crossorigin","anonymous"),m.load(),y=document.createElement("canvas"),y.width=960,y.height=480,videoImageContext=y.getContext("2d"),videoImageContext.textAlign="center",videoImageContext.fillStyle="#00ff00",videoImageContext.fillRect(0,
0,y.width,y.height),w||r?(m.autoplay=!1,m.setAttribute("webkit-playsinline","webkit-playsinline"),m.currentTime=0,videoImageContext.drawImage(m,0,0,y.width,y.height),N=new THREE.VideoTexture(y),N.format=THREE.RGBFormat):N=new THREE.VideoTexture(m),N.minFilter=THREE.LinearFilter,N.magFilter=THREE.LinearFilter,N.generateMipmaps=!1,Y=new THREE.MeshBasicMaterial({map:N,overdraw:!0})};H.prototype.render=function(){var g=this;var h=x.currentOffset();var t=x.totalOffset();wa+=t-Ba;Ba=t;window.addEventListener("resize",
function(){g.onWindowResize()},!1);window.addEventListener("scroll",function(){g.onWindowScroll()},!1);if(I||m){if(ca){ca=!1;if(I||!m.paused)w||r||x.Play();z++}h<za&&(1<ba?(t=U.substring(0,U.lastIndexOf(".")),t=10>p?t+"0"+p+".sopa":""+t+p+".sopa",x.setUrl(t),x.loadSopaData(),1==p?(wa=h,I||(m.currentTime=h/E)):0==p&&(oa||x.setLastLoop(!0)),p++,p>=ba&&(p=0)):wa=h);za=h;if(I)!P&&(h=parseInt(wa/sampleInterval),h==C+1||h<C)&&(C=h,C>=ya&&(C=0),V&&(h=0==C?l:10>C?l.substring(0,l.length-4)+"000"+C+".jpg":
100>C?l.substring(0,l.length-4)+"00"+C+".jpg":1E3>C?l.substring(0,l.length-4)+"0"+C+".jpg":l,g.getImage(h)));else if(X)m.readyState===m.HAVE_ENOUGH_DATA&&(X=!1);else{qa&&-1==z&&0<m.currentTime&&(m.pause(),z=3,k.innerHTML="Tap to start<BR>Please use stereo headphones");if(w||r)m.currentTime=wa/E,videoImageContext.drawImage(m,0,0,y.width,y.height);N&&(N.needsUpdate=!0)}requestAnimationFrame(function(){g.render()});J?(b.update(),S&&(D.rotateY(-e.rotation.y),w||r?-90==window.orientation?K=!0:180==window.orientation?
(la=!0,alert("Device orientation not supported!\nChange the device orientation and try again."),D.rotateY(Math.PI)):0==window.orientation&&(ia=!0,D.rotateY(Math.PI)):(h=screen.orientation||screen.mozOrientation||screen.msOrientation,"landscape-secondary"==h.type?K=!0:"portrait-secondary"==h.type?(la=!0,D.rotateY(F)):"portrait-primary"==h.type&&(D.rotateY(-F),ia=!0)),S=!1),K?(h=e.rotation.y+F,e.rotation.x+=d):la?(h=w||r?e.rotation.y:e.rotation.y+F,e.rotation.x-=A):ia?(h=w||r?e.rotation.y-Math.PI:e.rotation.y+
F,e.rotation.x+=A):(h=e.rotation.y-F,e.rotation.x-=d),e.rotation.x>F?e.rotation.x=F:e.rotation.x<-F&&(e.rotation.x=-F),K?(d+=c*Math.PI/(2*q),d>=Math.PI?d-=B:d<-Math.PI&&(d+=B),D.rotateY(a*Math.PI/(2*q)),u-=a*Math.PI/(2*q),u<-Math.PI?u+=B:u>=Math.PI&&(u-=B)):ia?(A+=c*Math.PI/(2*q),A>=Math.PI?A-=B:A<-Math.PI&&(A+=B),D.rotateY(-a*Math.PI/(2*q)),u+=a*Math.PI/(2*q),u>=Math.PI?u-=B:u<-Math.PI&&(u+=B)):la?(A-=c*Math.PI/(2*q),A<-Math.PI?A+=B:A>=Math.PI&&(A-=B),D.rotateY(-a*Math.PI/(2*q)),u+=a*Math.PI/(2*
q),u<-Math.PI?u+=B:u>=Math.PI&&(u-=B)):(d-=c*Math.PI/(2*q),d<-Math.PI?d+=B:d>=Math.PI&&(d-=B),D.rotateY(-a*Math.PI/(2*q)),u+=a*Math.PI/(2*q),u>=Math.PI?u-=B:u<-Math.PI&&(u+=B)),a=c=0,e.rotation.z=0):(S&&(e.rotation.y+=Math.PI,S=!1),e.rotation.y-=2E-5*na,e.rotation.x=e.rotation.x<=Math.PI/3&&e.rotation.x>=-Math.PI/3?e.rotation.x-2E-5*pa:e.rotation.x>Math.PI/3?Math.PI/3:-Math.PI/3,e.rotation.y>=B?e.rotation.y-=B:0>e.rotation.y&&(e.rotation.y+=B),h=e.rotation.y);h+=u;t=e.rotation.x;0>h?h+=B:h>=B&&(h-=
B);h=180*h/Math.PI;h-=180;t=180*t/Math.PI;var L=Math.abs(fa-parseInt(h));3<L&&(fa=parseInt(h),x.setPan(fa),J||(Z=!0));L=Math.abs(ga-parseInt(t));3<L&&180>L&&(ga=parseInt(t),x.setTilt(ga),J||(Z=!0));g.interv();f.render(ka,e)}};H.prototype.onWindowResize=function(){e.aspect=window.innerWidth*W/(window.innerHeight*aa);e.updateProjectionMatrix();f.setPixelRatio(window.devicePixelRatio);f.setSize(window.innerWidth*W,window.innerHeight*aa);q=window.innerWidth;M=window.innerHeight;da=q*(1-W)/2;g=document.getElementById("stage");
T=g.getBoundingClientRect();ja=T.bottom-T.top};H.prototype.onWindowScroll=function(){ma=window.pageYOffset};H.prototype.interv=function(){4!=z||x.beingPlayed()?0<x.fftWinSize()&&x.databaseReady()&&!xa&&!X&&(xa=!0,z=3,x.setup()&&(J&&qa&&!ra&&!I?(z=-1,k.innerHTML="Tap screen<BR>Please use stereo headphones",m.currentTime=0):k.innerHTML=J?"Tap to start<BR>Please use stereo headphones":"Click to start<BR>Please use stereo headphones",za=E=x.getSampleRate())):(I&&oa?(k.innerHTML=U+" was played. <BR>Good bye",
z++):(k.innerHTML=J?U+" was played. <BR>Tap back button to close this window.":U+" was played. <BR>Thank you.",z=2),ra=!0)};return H}();window.onload=function(){new sopaOpen};
Sopa=function(H){this.urlStr=H;var x=navigator.userAgent.toLowerCase(),S=!1,sa=!1,O=!1,xa=!1,ta=!0,J=0,qa,ra,w=new XMLHttpRequest,r=new XMLHttpRequest,Z=new Int16Array(130048),K=new Int16Array(130048),ia,la,X,I,P,oa=0,ca,V=0,g,q=0,M=0,da=0,ma=0,ja,W,aa,T,k,R,ka,m,y=0,N=36,e=18,G,Y=Array(256),D=[],na=[0,0,1],pa=0,ua=new Float32Array(2229),va=new Float32Array(2229);this.setup=function(){-1<x.indexOf("iphone")||-1<x.indexOf("ipod")||-1<x.indexOf("ipad")?O=!0:x.indexOf("android");try{T=window.AudioContext||
window.webkitAudioContext,k=new T}catch(U){return alert("Web Audio API is not supported in this browser"),!1}ka=k.sampleRate;if(0==V)return alert("SOPA data not available!"),!1;m=ka/V;N=36;e=18;q=4096;ca=0;G=new Float32Array(y);var a=y/8;for(var c=0;c<y;c++)G[c]=c<a?(1-Math.cos(Math.PI*c/a))/4:c>=y-a?(1-Math.cos(Math.PI*(y-c)/a))/4:.5;for(a=0;254>a;a++)D[a]=this.initCoord(a);for(c=0;256>c;c++){Y[c]=Array(72);for(var b=0;72>b;b++){Y[c][b]=Array(36);a=36<=b?-Math.PI*(72-b)/36:Math.PI*b/36;for(var f=
-18;18>f;f++){var g=Math.PI*f/36;g=this.modifySector(c,a,g);Y[c][b][f+18]=parseInt(g)}}}R=k.createScriptProcessor(q,2,2);return!0};this.loadDatabase=function(a,c){qa=a;ra=c;w.open("GET",qa,!0);w.responseType="arraybuffer";w.onreadystatechange=this.handleHrtf;w.send(null);r.open("GET",ra,!0);r.responseType="arraybuffer";r.onreadystatechange=this.handlePhase;r.send(null)};Sopa.prototype.handleHrtf=function(){4==w.readyState&&200==w.status&&(Z=new Int16Array(w.response),pa++,1<pa&&(sa=!0))};Sopa.prototype.handlePhase=
function(){4==r.readyState&&200==r.status&&(K=new Int16Array(r.response),pa++,1<pa&&(sa=!0))};this.loadSopaData=function(){this.loadSopa(this.handleSopa)};Sopa.prototype.loadSopa=function(a){var c=this,b=new XMLHttpRequest;b.open("GET",this.urlStr,!0);b.responseType="arraybuffer";b.onreadystatechange=function(){4==b.readyState&&(200!=b.status&&4==b.readyState?alert("HTTP error "+b.status):a.call(c,b))};b.send(null)};Sopa.prototype.handleSopa=function(a){a=a.response;var c=((new DataView(a)).byteLength-
44)/4;P=new Uint8Array(a,0,44);0==oa?(ia=new Uint8Array(a,44,4*c),X=new Int16Array(a,44,2*c)):(la=new Uint8Array(a,44,4*c),I=new Int16Array(a,44,2*c));0==ma&&(ta=this.checkHeader()?!0:!1);oa=0==oa?1:0};Sopa.prototype.checkHeader=function(){var a,c=new Uint8Array(4);for(a=8;12>a;a++)c[a-8]=P[a];if(83!=c[0]||79!=c[1]||80!=c[2]||65!=c[3])return alert("Data format error!"),!1;for(a=12;15>a;a++)c[a-12]=P[a];if(102!=c[0]||109!=c[1]||116!=c[2])return alert("Data format error!"),!1;if(16!=P[16])return alert("PCM data should be 16-bit depth!"),
!1;V=P[25]&255;V*=256;V+=P[24]&255;if(22050!=V&&44100!=V)return alert("Wrong sampleRate! "+V),!1;g=P[39];if(2>g)return alert("Sorry, this version is not supported"),!1;if(0==y){for(a=5;255!=ia[a]&&4096>=a;)a+=4;y=a-1;if(4096<y)return alert("Something wrong!"),!1;W=new Float32Array(y);aa=new Float32Array(y)}return!0};this.fftWinSize=function(){return ta?y:0};this.databaseReady=function(){return sa};this.beingPlayed=function(){return S};this.Play=function(){this.play()};this.currentOffset=function(){return M};
this.totalOffset=function(){return ma};this.getSampleRate=function(){return V};this.setLastLoop=function(a){xa=a};this.setUrl=function(a){this.urlStr=a};this.setPan=function(a){179<a?a=179:-180>a&&(a=-180);N=Math.floor(36+a/5)};this.setTilt=function(a){89<a?a=89:-90>a&&(a=-90);e=Math.floor(18+a/5)};this.setCardioid=function(a,c,b){J=a;focus=void 0==c?Math.PI:c+Math.PI;void 0==b&&(b=0);na[0]=Math.sin(focus);na[1]=Math.sin(b);na[2]=Math.cos(focus)};Sopa.prototype.play=function(){var a=this;S?(R.disconnect(k.destination),
R.onaudioprocess=null,S=!1):(ja=ca=currenttime=M=da=ma=0,R.onaudioprocess=function(c){a.Process.call(a,c)},O&&k.createBufferSource().start(0),S=!0,R.connect(k.destination))};Sopa.prototype.Process=function(a){var c=y,b=2*y,f=c/2,L=c/2,k=1/ka,x=44100*c/(512*V),ea,l,v=1,fa=1,ga=new Float32Array(c),z=new Float32Array(c),w=new Float32Array(c),C=new Float32Array(c),ba=a.outputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(1);var r=ja-da,D=ua.subarray(0,r);ba.set(D,0);D=va.subarray(0,r);a.set(D,
0);da+=r;currenttime=da/ka;for(var D=Math.ceil((q-r)/(m*f)),R=0;R<D;R++){var p=2*M;if(0==ca)if(p+b>X.length){var E=X.subarray(p,X.length);var d=null!=I?I.subarray(0,p+b-X.length):X.subarray(0,p+b-X.length);var A=new Int16Array(E.length+d.length);A.set(E);A.set(d,E.length)}else A=X.subarray(p,p+b);else p+b>I.length?(E=I.subarray(p,I.length),d=X.subarray(0,p+b-I.length),A=new Int16Array(E.length+d.length),A.set(E),A.set(d,E.length)):A=I.subarray(p,p+b);E=new Float32Array(y);var u=new Float32Array(y);
for(d=0;d<y;d++)E[d]=A[2*d+1];d={real:E,image:u};this.fastFt(d,!1);A=2*p;var B=A+c;z[L]=E[L]*Math.cos(u[L]);ga[L]=E[L]*Math.cos(u[L]);C[L]=E[L]*Math.sin(u[L]);w[L]=E[L]*Math.sin(u[L]);for(d=0;d<L;d++){p=c-d;var F=parseInt(d/x);var Q=0==F?F:511-F;var h=0==ca?0==d%2?ia[A+2*d+1]:ia[A+2*(d-1)]:0==d%2?la[A+2*d+1]:la[A+2*(d-1)];var t=2<g?0==ca?0==d%2?ia[B+2*d+1]:ia[B+2*(d-1)]:0==d%2?la[B+2*d+1]:la[B+2*(d-1)]:h;if(0==F){if(t=F=E[d],Q=h=u[d],0<d){var H=ea=E[p];var ha=l=u[p]}}else if(254<=h&&254<=t)t=F=E[d],
Q=h=u[d],H=ea=E[p],ha=l=u[p];else{253<h?h=t:253<t&&(t=h);H=this.opposit(h);h=Y[h][N][e];var T=this.opposit(t);t=Y[t][N][e];0<J&&(ea=this.initCoord(h),v=this.polar(na,ea),ea=this.initCoord(t),fa=this.polar(na,ea),2==J&&(v*=v,fa*=fa));H=0==N?Y[H][N][e]:Y[H][72-N][e];T=0==N?Y[T][N][e]:Y[T][72-N][e];var O=512*h+F;ha=512*h+Q;var n=Z[O]*v/2048;var P=512*t+F;var S=512*t+Q;n+=Z[P]*fa/2048;n/=2;t=E[d]*n;n=K[O]/1E4;n+=K[P]/1E4;n/=2;31415<Math.abs(K[O]-K[P])&&(n=0>n?n+Math.PI:n-Math.PI);h=u[d]+n;n=Z[ha]*v/2048;
n+=Z[S]*fa/2048;n/=2;ea=E[p]*n;n=K[ha]/1E4;n+=K[S]/1E4;n/=2;31415<Math.abs(K[ha]-K[S])&&(n=0>n?n+Math.PI:n-Math.PI);l=u[p]+n;O=512*H+F;ha=512*H+Q;n=Z[O]*v/2048;P=512*T+F;S=512*T+Q;n+=Z[P]*fa/2048;n/=2;F=E[d]*n;n=K[O]/1E4;n+=K[P]/1E4;n/=2;31415<Math.abs(K[O]-K[P])&&(n=0>n?n+Math.PI:n-Math.PI);Q=u[d]+n;n=Z[ha]*v/2048;n+=Z[S]*fa/2048;n/=2;H=E[p]*n;n=K[ha]/1E4;n+=K[S]/1E4;n/=2;31415<Math.abs(K[ha]-K[S])&&(n=0>n?n+Math.PI:n-Math.PI);ha=u[p]+n}z[d]=F*Math.cos(Q);ga[d]=t*Math.cos(h);C[d]=F*Math.sin(Q);w[d]=
t*Math.sin(h);0<d&&(z[p]=H*Math.cos(ha),ga[p]=ea*Math.cos(l),C[p]=H*Math.sin(ha),w[p]=ea*Math.sin(l))}d={real:z,image:C};this.fastFt(d,!0);d={real:ga,image:w};this.fastFt(d,!0);for(d=0;d<c;d++)z[d]*=G[d],ga[d]*=G[d],W[d]+=z[d],aa[d]+=ga[d];for(d=0;d<f;d++){E=W[d+1]/32768;u=aa[d+1]/32768;p=W[d]/32768;A=aa[d]/32768;for(B=ma/V;currenttime<B;)Q=(B-currenttime)*V,F=p*Q+E*(1-Q),Q=A*Q+u*(1-Q),r<q?(ba[r]=F,a[r]=Q,da++,currenttime=da/ka):(ua[r-q]=F,va[r-q]=Q,currenttime+=k),r++,ja++;ma++}d=W.subarray(f);W=
new Float32Array(y);W.set(d,0);d=aa.subarray(f);aa=new Float32Array(y);aa.set(d,0);M+f>=(0==ca?X.length/2:I.length/2)?xa?(R=D,this.play()):(M=0,ca=0==ca&&I?1:0):M+=f}};Sopa.prototype.fastFt=function(a,c){var b,f,e,g,q=y;var k=2*Math.PI;var l=a.real,v=a.image;if(!c)for(b=0;b<q;b++){v[b]=0;var m=(1-Math.cos(k*b/q))/2;l[b]*=m}b=Math.PI;for(k=m=0;k<q-1;k++){if(k<=m){var r=l[k];l[k]=l[m];l[m]=r;r=v[k];v[k]=v[m];v[m]=r}for(f=q/2;f<=m;)m-=f,f/=2;m+=f}var z=1;for(m=c?1:-1;z<=q/2;){var x=Math.cos(b);var C=
Math.sin(m*b);k=1;for(e=f=0;e<z;e++){for(g=e;g<q;g+=2*z){var w=g+z;r=l[w]*k-v[w]*f;var D=v[w]*k+l[w]*f;l[w]=l[g]-r;v[w]=v[g]-D;l[g]+=r;v[g]+=D}r=x*k-C*f;f=C*k+x*f;k=r}z*=2;b/=2}if(!c)for(b=0;b<q;b++)l[b]/=q,v[b]/=q,m=Math.sqrt(l[b]*l[b]+v[b]*v[b]),k=Math.atan2(v[b],l[b]),l[b]=m,v[b]=k};Sopa.prototype.initCoord=function(a){var c=Array(3),b=Math.PI/12;127<=a&&(b*=-1);if(0==a)c[0]=c[2]=0,c[1]=1;else if(253==a)c[0]=c[2]=0,c[1]=-1;else{if(9>a||245<=a){var f=Math.PI/4;var e=Math.cos(5*b);9>a?(c[1]=Math.sin(5*
b),a=f*(a-1)-Math.PI):(c[1]=Math.sin(-5*b),a=f*(252-a))}else 25>a||229<=a?(f=Math.PI/8,e=Math.cos(4*b),25>a?(c[1]=Math.sin(4*b),a=f*(a-9)-Math.PI):(c[1]=Math.sin(-4*b),a=f*(244-a))):49>a||205<=a?(f=Math.PI/12,e=Math.cos(3*b),49>a?(c[1]=Math.sin(3*b),a=f*(a-25)-Math.PI):(c[1]=Math.sin(-3*b),a=f*(228-a))):79>a||175<=a?(f=Math.PI/15,e=Math.cos(2*b),79>a?(c[1]=Math.sin(2*b),a=f*(a-49)-Math.PI):(c[1]=Math.sin(-2*b),a=f*(204-a))):111>a||143<=a?(f=Math.PI/16,e=Math.cos(b),111>a?(c[1]=Math.sin(b),a=f*(a-
79)-Math.PI):(c[1]=Math.sin(-b),a=f*(174-a))):(f=Math.PI/16,e=1,c[1]=0,a=127>a?f*(a-111)-Math.PI:f*(142-a));c[0]=e*Math.sin(a);c[2]=e*Math.cos(a)}return c};Sopa.prototype.opposit=function(a){return 0==a||253<=a?a:9>a?1==a?a:10-a:25>a?9==a?a:34-a:49>a?25==a?a:74-a:79>a?49==a?a:128-a:111>a?79==a?a:190-a:127>a?111==a?a:15+a:143>a?142==a?a:a-15:175>a?174==a?a:316-a:205>a?204==a?a:378-a:229>a?228==a?a:432-a:245>a?244==a?a:472-a:252==a?a:496-a};Sopa.prototype.modifySector=function(a,c,b){var e=0;if(253<
a)return a;0!=a&&253!=a&&(e=Math.atan2(D[a][0],D[a][2])+c);var g=0==a||253==a?0:9>a||245<=a?Math.cos(5*Math.PI/12):25>a||229<=a?Math.cos(Math.PI/3):49>a||205<=a?Math.cos(Math.PI/4):79>a||175<=a?Math.cos(Math.PI/6):111>a||143<=a?Math.cos(Math.PI/12):1;c=[];c[0]=g*Math.sin(e);c[2]=g*Math.cos(e);c[1]=D[a][1];0!=b&&0!=c[2]&&(a=c[1],e=c[2],b=Math.atan2(a,e)+b,a=Math.sqrt(e*e+a*a),c[2]=a*Math.cos(b),c[1]=a*Math.sin(b));return this.calcSector(c)};Sopa.prototype.calcSector=function(a){var c=2*Math.PI;if(a[1]>=
Math.sin(11*Math.PI/24))return 0;if(a[1]<=-Math.sin(11*Math.PI/24))return 253;var b=Math.atan2(a[0],a[2]);a[1]>=Math.sin(3*Math.PI/8)?(0>b&&(b+=c),a=1+b/(Math.PI/4)):a[1]<=-Math.sin(3*Math.PI/8)?a=249-b/(Math.PI/4):a[1]>=Math.sin(7*Math.PI/24)?(0>b&&(b+=c),a=9+b/(Math.PI/8)):a[1]<=-Math.sin(7*Math.PI/24)?a=237-b/(Math.PI/8):a[1]>=Math.sin(5*Math.PI/24)?(0>b&&(b+=c),a=25+b/(Math.PI/12)):a[1]<=-Math.sin(5*Math.PI/24)?a=217-b/(Math.PI/12):a[1]>=Math.sin(Math.PI/8)?(0>b&&(b+=c),a=49+b/(Math.PI/15)):a[1]<=
-Math.sin(Math.PI/8)?a=190-b/(Math.PI/15):a[1]>=Math.sin(Math.PI/24)?(0>b&&(b+=c),a=79+b/(Math.PI/16)):a=a[1]<=-Math.sin(Math.PI/24)?159-b/(Math.PI/16):0>b?127-b/(Math.PI/16):b==Math.PI?142:111+b/(Math.PI/16);return a};Sopa.prototype.polar=function(a,c){return(1+Math.cos(Math.acos(c[0]*a[0]+c[1]*a[1]+c[2]*a[2])))/2}};