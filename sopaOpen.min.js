var sopaOpen=function(){function M(){if(Detector.webgl)if(XMLHttpRequest){try{var a=document.createElement("canvas");var c=!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(N){c=!1}if(b=c?new THREE.WebGLRenderer({alpha:!0}):null){I=new THREE.Scene;if(-1<H.indexOf("android"))J=!0,-1<H.indexOf("firefox")||!(-1<H.indexOf("opera")||-1<H.indexOf("opr"))||(qa=!0);else if(-1<H.indexOf("iphone")||-1<H.indexOf("ipod")||-1<H.indexOf("ipad"))y=J=!0;if(window.location.search){c=
window.location.search.substring(1,window.location.search.length).split("&");for(a=0;a<c.length;a++){var d=c[a].split("=");"sopa"==decodeURIComponent(d[0])?document.form0.elements.sopa.value=decodeURIComponent(d[1]):"image"==decodeURIComponent(d[0])?document.form0.elements.image.value=decodeURIComponent(d[1]):"numFiles"==decodeURIComponent(d[0])?document.form0.elements.numFiles.value=decodeURIComponent(d[1]):"numStart"==decodeURIComponent(d[0])&&(document.form0.elements.numStart.value=decodeURIComponent(d[1]))}K=
!0}this.init()}else alert("Sorry, your browser does not seem to support WebGL.\nPanoramic video is not available.\nOnly the panoramic sound may be played.")}else alert("Sorry, your browser does not seem to support XMLHttpRequest.\nPanoramic sound cannot be loaded.");else Detector.addGetWebGLMessage(),alert("Sorry, your graphic card does not seem to support WebGL.")}var t,O=!0,ta=!0,K=!1,xa=!1,ua=!1,J=!1,qa=!1,ra=!1,y=!1,z=!1,Y=!1,D=!1,ia=!1,ka=!0,A=!1,ea=!1,F=!1,sa=!1,fa=!1,W=!1,e,h,Z,ga,la,ja,T,
P,n,H=navigator.userAgent.toLowerCase(),I,m,aa,w,f,u,ma,C,oa=0,na=0,pa=0,va=0,ba=0,a=0,c,b,U=0,q,B,ya=0,ca=0,r=0,v,p,L,za,Aa=0,wa=0,x,da,G=0,Q=0,g=0,k=2*Math.PI,d=Math.PI/2;M.prototype.init=function(){if(K)if((e=document.form0.elements.sopa)&&0<e.value.length)urlStr=e.value;else{alert("SOPA file is not specified!");return}else{e=document.getElementById("myUrl");if(null==e){alert("Location ot SOPA file is not specified!");return}urlStr=e.innerHTML}var d=urlStr;K&&(L=(e=document.form0.elements.numFiles)&&
0<e.value.length?e.value:1);if(!K||2>L)e=document.getElementById("numFiles"),L=null==e?1:e.innerHTML;K&&(x=(e=document.form0.elements.numStart)&&0<e.value.length?e.value:0);if(!K||1>x)e=document.getElementById("numStart"),x=null==e?0:parseInt(e.innerHTML);e=document.getElementById("fullscreen");null!=e&&1==parseInt(e.innerHTML)&&(W=!0);e=document.getElementById("loop");F=null==e||1==parseInt(e.innerHTML)?!1:!0;e=document.getElementById("cube");ua=null==e?!1:0<parseInt(e.innerHTML)?!0:!1;hrtfStr=document.getElementById("hrtfUrl").innerHTML;
q=document.getElementById("phaseUrl").innerHTML;1<L&&(d=urlStr.substring(0,urlStr.lastIndexOf(".")),d=10>x?d+"0"+x+".sopa":d+x+".sopa");t=new Sopa(d);t.setCardioid(0,0,0);t.loadDatabase(hrtfStr,q);t.loadSopaData();1<L&&(x++,x>=L&&(x=0));K?(e=document.form0.elements.image)&&0<e.value.length?B=e.value:(d=urlStr.substring(0,urlStr.lastIndexOf(".")),B=d+".mp4"):(e=document.getElementById("imgUrl"))&&0<e.innerHTML.length&&(B=e.innerHTML);d=B;if(".jpg"==B.substring(B.lastIndexOf("."),B.length)){A=!0;ka=
!1;var E=document.getElementById("numImage");null==E?(v=1,p=0):(v=E.innerHTML,e=document.getElementById("jpgStart"),p=null==e?0:parseInt(e.innerHTML),0<p&&(10>p?d=B.slice(0,B.length-4)+"000"+p+".jpg":100>p?d=B.slice(0,B.length-4)+"00"+p+".jpg":1E3>p&&(d=B.slice(0,B.length-4)+"0"+p+".jpg")));1<v?(E=document.getElementById("interval"),null==E?(alert("Slide interval is not defined!"),sampleInterval=22050):sampleInterval=E.innerHTML):ea=!0}h=window.innerWidth;Z=window.innerHeight;J&&(document.body.style.overflow=
"hidden",document.body.style.position="fixed");this.getImage(d);C=new THREE.Mesh(u,ma);U++;C.position.set(0,0,0);C.rotation.order="YXZ";I.add(C);T=.96;ga=h*(1-T)/2;f=new THREE.PerspectiveCamera(75,h*T/(.8*Z),1,1E3);f.position.set(0,0,.1);f.lookAt({x:0,y:0,z:-1});f.rotation.order="YXZ";b.setSize(h*T,.8*Z);b.setClearColor({color:0});b.domElement.style.position="relative";b.domElement.style.bottom="0px";b.domElement.style.left=J?ga+"px":"0px";document.getElementById("stage").appendChild(b.domElement);
b.setPixelRatio(window.devicePixelRatio);b.render(I,f);e=document.getElementById("stage");P=e.getBoundingClientRect();ja=P.bottom-P.top;la=window.pageYOffset;J?(window.DeviceOrientationEvent?window.addEventListener("deviceorientation",this.orient,!0):alert("deviceorientation is not supported"),c=new THREE.DeviceOrientationControls(f,b.domElement),c.connect()):window.addEventListener("mousemove",function(a){var b=P.top-la;a.clientX<ga||a.clientX>h-ga?oa=na=0:a.clientY<b||a.clientY>P.bottom-la?oa=na=
0:(oa=a.clientX>=h/3&&a.clientX<2*h/3?0:a.clientX<h/3?a.clientX-h/3:a.clientX-2*h/3,na=a.clientY>=b+ja/3&&a.clientY<b+2*ja/3?0:a.clientY<b+ja/3?a.clientY-(b+ja/3):a.clientY-(b+2*ja/3))},!1);n=document.createElement("div");n.style.position="relative";n.style.width=h;n.style.height=Z/8;n.style.color="orange";n.style.fontSize="32px";n.style.bottom=J?Z/4+"px":Z/6+"px";n.innerHTML="Loading data. Wait for a moment.<BR>Stereo headphones are necessary";n.style.left="0px";n.style.textAlign="center";n.style.filter=
"dropshadow(color=#ffff0000, offx=10, offy=10, positive=true)";document.getElementById("stage").appendChild(n);this.render();this.initVariables();b.domElement.addEventListener("click",function(){z&&(z=!1);4==r?(t.Play(),ra=!0,A||y||m.pause(),1<L&&F?(n.innerHTML=urlStr+" was played. <BR>Good bye",r++):(n.innerHTML=urlStr+" was played. <BR>Thank you.",r=2)):4<r?n.innerHTML="Please reload this page":2==r?(ra&&r++,A||(m.currentTime=0),n.innerHTML=J?"Tap to start<BR>Please use stereo headphones":"Click to start<BR>Please use stereo headphones"):
3==r?(W&&(this.webkitRequestFullScreen?this.webkitRequestFullScreen():this.mozRequestFullScreen&&this.mozRequestFullScreen()),wa=0,n.innerHTML=J?"Tap to stop reproduction<BR>Rotate device to change panning":"Click to stop reproduction<BR>Move the mouse pointer to change panning",A||(m.currentTime=0),1<L?t.setLastLoop(!1):t.setLastLoop(!0),y&&t.Play(),sa=!0,y||A||m.play()):-1==r&&qa&&(m.play(),n.innerHTML="Preparing data, wait for a while<BR>Use stereo headphones")},!1);J&&(window.addEventListener("touchmove",
function(a){a.preventDefault()},!1),b.domElement.addEventListener("touchstart",function(a){a=a.changedTouches[0];va=parseInt(a.clientY);pa=parseInt(a.clientX)},!1),b.domElement.addEventListener("touchmove",function(b){b=b.changedTouches[0];a=parseInt(b.clientY)-va;ba=parseInt(b.clientX)-pa;va=parseInt(b.clientY);pa=parseInt(b.clientX);-90==window.orientation&&(ba*=-1)},!1))};M.prototype.orient=function(a){a.alpha||a.gamma||a.beta?ta&&(G=a.gamma*Math.PI/180,Q=a.beta*Math.PI/180,ta=!1):alert("deviceorientation not available");
window.removeEventListener("deviceorientation",this.orient,!0)};M.prototype.initVariables=function(){r=ca=ya=0};M.prototype.getImage=function(a){if(A){0==U&&(ma=ua?new THREE.MeshBasicMaterial({color:16777215,side:THREE.BackSide,overdraw:!0}):new THREE.MeshBasicMaterial({color:16777215,overdraw:!0}));fa=!1;var b=new THREE.TextureLoader;b.crossOrigin="*";b.load(a,function(a){ma.map=a;ma.needsUpdate=!0},function(a){a.loaded==a.total&&(fa=!0)},function(a){alert("TextureLoader not supported!")});if(0==
U)if(ua){a=[new THREE.Vector2(0,.5),new THREE.Vector2(.25,.5),new THREE.Vector2(.25,1),new THREE.Vector2(0,1)];var b=[new THREE.Vector2(.25,.5),new THREE.Vector2(.5,.5),new THREE.Vector2(.5,1),new THREE.Vector2(.25,1)],c=[new THREE.Vector2(.5,.5),new THREE.Vector2(.75,.5),new THREE.Vector2(.75,1),new THREE.Vector2(.5,1)],d=[new THREE.Vector2(.75,.5),new THREE.Vector2(1,.5),new THREE.Vector2(1,1),new THREE.Vector2(.75,1)],f=[new THREE.Vector2(0,0),new THREE.Vector2(.25,0),new THREE.Vector2(.25,.5),
new THREE.Vector2(0,.5)],g=[new THREE.Vector2(.25,0),new THREE.Vector2(.5,0),new THREE.Vector2(.5,.5),new THREE.Vector2(.25,.5)];u=new THREE.CubeGeometry(10,10,10);u.faceVertexUvs[0]=[];u.faceVertexUvs[0][0]=[d[2],d[1],d[3]];u.faceVertexUvs[0][1]=[d[1],d[0],d[3]];u.faceVertexUvs[0][2]=[b[2],b[1],b[3]];u.faceVertexUvs[0][3]=[b[1],b[0],b[3]];u.faceVertexUvs[0][4]=[g[2],g[1],g[3]];u.faceVertexUvs[0][5]=[g[1],g[0],g[3]];u.faceVertexUvs[0][6]=[f[2],f[1],f[3]];u.faceVertexUvs[0][7]=[f[1],f[0],f[3]];u.faceVertexUvs[0][8]=
[a[2],a[1],a[3]];u.faceVertexUvs[0][9]=[a[1],a[0],a[3]];u.faceVertexUvs[0][10]=[c[2],c[1],c[3]];u.faceVertexUvs[0][11]=[c[1],c[0],c[3]]}else u=new THREE.SphereGeometry(10,12,12),u.scale(-1,1,1)}else u=new THREE.SphereGeometry(10,12,12),u.scale(-1,1,1),m=document.createElement("video"),m.style.visibility="true",m.width=960,m.height=480,m.loop=F?!0:!1,m.muted=!0,m.src=a,m.setAttribute("crossorigin","anonymous"),m.load(),aa=document.createElement("canvas"),aa.width=960,aa.height=480,videoImageContext=
aa.getContext("2d"),videoImageContext.textAlign="center",videoImageContext.fillStyle="#00ff00",videoImageContext.fillRect(0,0,aa.width,aa.height),y?(m.autoplay=!1,m.setAttribute("webkit-playsinline","webkit-playsinline"),m.currentTime=0,videoImageContext.drawImage(m,0,0,aa.width,aa.height),w=new THREE.VideoTexture(aa),w.format=THREE.RGBFormat):w=new THREE.VideoTexture(m),w.minFilter=THREE.LinearFilter,w.magFilter=THREE.LinearFilter,w.generateMipmaps=!1,ma=new THREE.MeshBasicMaterial({map:w,overdraw:!0})};
M.prototype.render=function(){var U=this;var e=t.currentOffset();var q=t.totalOffset();wa+=q-Aa;Aa=q;window.addEventListener("resize",function(){U.onWindowResize()},!1);window.addEventListener("scroll",function(){U.onWindowScroll()},!1);if(A||m){if(sa){sa=!1;if(A||!m.paused)y||t.Play();r++}e<za&&(1<L?(q=urlStr.substring(0,urlStr.lastIndexOf(".")),q=10>x?q+"0"+x+".sopa":""+q+x+".sopa",t.setUrl(q),t.loadSopaData(),1==x?(wa=e,A||(m.currentTime=e/da)):0==x&&(F||t.setLastLoop(!0)),x++,x>=L&&(x=0)):wa=
e);za=e;A?!ea&&(e=parseInt(wa/sampleInterval),e==p+1||e<p)&&(p=e,p>=v&&(p=0),fa&&(e=0==p?B:10>p?B.substring(0,B.length-4)+"000"+p+".jpg":100>p?B.substring(0,B.length-4)+"00"+p+".jpg":1E3>p?B.substring(0,B.length-4)+"0"+p+".jpg":B,U.getImage(e))):ka?m.readyState===m.HAVE_ENOUGH_DATA&&(ka=!1):(qa&&-1==r&&0<m.currentTime&&(m.pause(),r=3,n.innerHTML="Tap to start<BR>Please use stereo headphones"),y&&(m.currentTime=wa/da,videoImageContext.drawImage(m,0,0,aa.width,aa.height)),w&&(w.needsUpdate=!0));requestAnimationFrame(function(){U.render()});
J?(c.update(),O&&(C.rotateY(-f.rotation.y),y?-90==window.orientation?Y=!0:180==window.orientation?(ia=!0,alert("Device orientation not supported!\nChange the device orientation and try again."),C.rotateY(Math.PI)):0==window.orientation&&(D=!0,C.rotateY(Math.PI)):(e=screen.orientation||screen.mozOrientation||screen.msOrientation,"landscape-secondary"==e.type?Y=!0:"portrait-secondary"==e.type?(ia=!0,alert("Portrait orientation is not supported!\nTry the landscape orientation."),C.rotateY(d)):"portrait-primary"==
e.type&&(C.rotateY(-d),alert("Portrait orientation is not supported!\nTry the landscape orientation."),D=!0)),O=!1),Y?(q=f.rotation.y+d,f.rotation.x+=G):ia?(q=y?f.rotation.y:f.rotation.y+d,f.rotation.x-=Q):D?(q=y?f.rotation.y-Math.PI:f.rotation.y+d,f.rotation.x+=Q):(q=f.rotation.y-d,f.rotation.x-=G),Y?(G+=a*Math.PI/(2*h),G>=Math.PI?G-=k:G<-Math.PI&&(G+=k),C.rotateY(ba*Math.PI/(2*h)),g-=ba*Math.PI/(2*h),g<-Math.PI?g+=k:g>=Math.PI&&(g-=k)):D?(Q+=a*Math.PI/(2*h),Q>=Math.PI?Q-=k:Q<-Math.PI&&(Q+=k),C.rotateY(-ba*
Math.PI/(2*h)),g+=ba*Math.PI/(2*h),g>=Math.PI?g-=k:g<-Math.PI&&(g+=k)):ia?(Q-=a*Math.PI/(2*h),Q<-Math.PI?Q+=k:Q>=Math.PI&&(Q-=k),C.rotateY(-ba*Math.PI/(2*h)),g+=ba*Math.PI/(2*h),g<-Math.PI?g+=k:g>=Math.PI&&(g-=k)):(G-=a*Math.PI/(2*h),G<-Math.PI?G+=k:G>=Math.PI&&(G-=k),C.rotateY(-ba*Math.PI/(2*h)),g+=ba*Math.PI/(2*h),g>=Math.PI?g-=k:g<-Math.PI&&(g+=k)),ba=a=0,f.rotation.z=0):(O&&(f.rotation.y+=Math.PI,O=!1),f.rotation.y-=5E-5*oa,f.rotation.x=f.rotation.x<=Math.PI/3&&f.rotation.x>=-Math.PI/3?f.rotation.x-
5E-5*na:f.rotation.x>Math.PI/3?Math.PI/3:-Math.PI/3,f.rotation.y>k?f.rotation.y-=k:0>f.rotation.y&&(f.rotation.y+=k),q=f.rotation.y);q+=g;e=f.rotation.x;0>q?q+=k:q>=k&&(q-=k);q=180*q/Math.PI;q-=180;e=180*e/Math.PI;3<Math.abs(ya-parseInt(q))&&(ya=parseInt(q),t.setPan(ya),J||(z=!0));3<Math.abs(ca-parseInt(e))&&(ca=parseInt(e),t.setTilt(ca),J||(z=!0));U.interv();b.render(I,f)}};M.prototype.onWindowResize=function(){f.aspect=window.innerWidth/window.innerHeight;f.updateProjectionMatrix();b.setPixelRatio(window.devicePixelRatio);
b.setSize(window.innerWidth*T,window.innerHeight*T);h=window.innerWidth;Z=window.innerHeight;ga=h*(1-T)/2;e=document.getElementById("stage");P=e.getBoundingClientRect();ja=P.bottom-P.top};M.prototype.onWindowScroll=function(){la=window.pageYOffset};M.prototype.interv=function(){4!=r||t.beingPlayed()?0<t.fftWinSize()&&t.databaseReady()&&!xa&&!ka&&(xa=!0,r=3,t.setup()&&(J&&qa&&!ra&&!A?(r=-1,n.innerHTML="Tap on the image<BR>Please use stereo headphones",m.currentTime=0):n.innerHTML=J?"Tap to start<BR>Please use stereo headphones":
"Click to start<BR>Please use stereo headphones",za=da=t.getSampleRate())):(A&&F?(n.innerHTML=urlStr+" was played. <BR>Good bye",r++):(n.innerHTML=urlStr+" was played. <BR>Thank you.",r=2),ra=!0)};return M}();window.onload=function(){new sopaOpen};
Sopa=function(M){this.urlStr=M;var t=navigator.userAgent.toLowerCase(),O=!1,ta=!1,K=!1,xa=!1,ua=!0,J=0,qa,ra,y=new XMLHttpRequest,z=new XMLHttpRequest,Y=new Int16Array(130048),D=new Int16Array(130048),ia,ka,A,ea,F,sa=0,fa,W=0,e,h=0,Z=0,ga=0,la=0,ja,T,P,n,H,I,m,aa,w=0,f=36,u=18,ma,C=Array(256),oa=[],na=[0,0,1],pa=0,va=new Float32Array(2229),ba=new Float32Array(2229);this.setup=function(){-1<t.indexOf("iphone")||-1<t.indexOf("ipod")||-1<t.indexOf("ipad")?K=!0:t.indexOf("android");try{n=window.AudioContext||
window.webkitAudioContext,H=new n}catch(B){return alert("Web Audio API is not supported in this browser"),!1}m=H.sampleRate;if(0==W)return alert("SOPA data not available!"),!1;aa=m/W;f=36;u=18;h=4096;fa=0;ma=new Float32Array(w);var a=w/8;for(var c=0;c<w;c++)ma[c]=c<a?(1-Math.cos(Math.PI*c/a))/4:c>=w-a?(1-Math.cos(Math.PI*(w-c)/a))/4:.5;for(a=0;254>a;a++)oa[a]=this.initCoord(a);for(c=0;256>c;c++){C[c]=Array(72);for(var b=0;72>b;b++){C[c][b]=Array(36);a=36<=b?-Math.PI*(72-b)/36:Math.PI*b/36;for(var e=
-18;18>e;e++){var q=Math.PI*e/36;q=this.modifySector(c,a,q);C[c][b][e+18]=parseInt(q)}}}I=H.createScriptProcessor(h,2,2);return!0};this.loadDatabase=function(a,c){qa=a;ra=c;y.open("GET",qa,!0);y.responseType="arraybuffer";y.onreadystatechange=this.handleHrtf;y.send(null);z.open("GET",ra,!0);z.responseType="arraybuffer";z.onreadystatechange=this.handlePhase;z.send(null)};Sopa.prototype.handleHrtf=function(){4==y.readyState&&200==y.status&&(Y=new Int16Array(y.response),pa++,1<pa&&(ta=!0))};Sopa.prototype.handlePhase=
function(){4==z.readyState&&200==z.status&&(D=new Int16Array(z.response),pa++,1<pa&&(ta=!0))};this.loadSopaData=function(){this.loadSopa(this.handleSopa)};Sopa.prototype.loadSopa=function(a){var c=this,b=new XMLHttpRequest;b.open("GET",this.urlStr,!0);b.responseType="arraybuffer";b.onreadystatechange=function(){4==b.readyState&&(200!=b.status&&4==b.readyState?alert("HTTP error "+b.status):a.call(c,b))};b.send(null)};Sopa.prototype.handleSopa=function(a){a=a.response;var c=((new DataView(a)).byteLength-
44)/4;F=new Uint8Array(a,0,44);0==sa?(ia=new Uint8Array(a,44,4*c),A=new Int16Array(a,44,2*c)):(ka=new Uint8Array(a,44,4*c),ea=new Int16Array(a,44,2*c));0==la&&(ua=this.checkHeader()?!0:!1);sa=0==sa?1:0};Sopa.prototype.checkHeader=function(){var a,c=new Uint8Array(4);for(a=8;12>a;a++)c[a-8]=F[a];if(83!=c[0]||79!=c[1]||80!=c[2]||65!=c[3])return alert("Data format error!"),!1;for(a=12;15>a;a++)c[a-12]=F[a];if(102!=c[0]||109!=c[1]||116!=c[2])return alert("Data format error!"),!1;if(16!=F[16])return alert("PCM data should be 16-bit depth!"),
!1;W=F[25]&255;W*=256;W+=F[24]&255;if(22050!=W&&44100!=W)return alert("Wrong sampleRate! "+W),!1;e=F[39];if(2>e)return alert("Sorry, this version is not supported"),!1;if(0==w){for(a=5;255!=ia[a]&&4096>=a;)a+=4;w=a-1;if(4096<w)return alert("Something wrong!"),!1;T=new Float32Array(w);P=new Float32Array(w)}return!0};this.fftWinSize=function(){return ua?w:0};this.databaseReady=function(){return ta};this.beingPlayed=function(){return O};this.Play=function(){this.play()};this.currentOffset=function(){return Z};
this.totalOffset=function(){return la};this.getSampleRate=function(){return W};this.setLastLoop=function(a){xa=a};this.setUrl=function(a){this.urlStr=a};this.setPan=function(a){179<a?a=179:-180>a&&(a=-180);f=Math.floor(36+a/5)};this.setTilt=function(a){89<a?a=89:-90>a&&(a=-90);u=Math.floor(18+a/5)};this.setCardioid=function(a,c,b){J=a;focus=void 0==c?Math.PI:c+Math.PI;void 0==b&&(b=0);na[0]=Math.sin(focus);na[1]=Math.sin(b);na[2]=Math.cos(focus)};Sopa.prototype.play=function(){var a=this;O?(I.disconnect(H.destination),
I.onaudioprocess=null,O=!1):(ja=fa=currenttime=Z=ga=la=0,I.onaudioprocess=function(c){a.Process.call(a,c)},K&&H.createBufferSource().start(0),O=!0,I.connect(H.destination))};Sopa.prototype.Process=function(a){var c=w,b=2*w,U=c/2,q=c/2,B=1/m,t=44100*c/(512*W),ca,r,v=1,p=1,L=new Float32Array(c),n=new Float32Array(c),y=new Float32Array(c),H=new Float32Array(c),x=a.outputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(1);var da=ja-ga,G=va.subarray(0,da);x.set(G,0);G=ba.subarray(0,da);a.set(G,
0);ga+=da;currenttime=ga/m;for(var G=Math.ceil((h-da)/(aa*U)),Q=0;Q<G;Q++){var g=2*Z;if(0==fa)if(g+b>A.length){var k=A.subarray(g,A.length);var d=null!=ea?ea.subarray(0,g+b-A.length):A.subarray(0,g+b-A.length);var S=new Int16Array(k.length+d.length);S.set(k);S.set(d,k.length)}else S=A.subarray(g,g+b);else g+b>ea.length?(k=ea.subarray(g,ea.length),d=A.subarray(0,g+b-ea.length),S=new Int16Array(k.length+d.length),S.set(k),S.set(d,k.length)):S=ea.subarray(g,g+b);k=new Float32Array(w);var E=new Float32Array(w);
for(d=0;d<w;d++)k[d]=S[2*d+1];d={real:k,image:E};this.fastFt(d,!1);S=2*g;var F=S+c;n[q]=k[q]*Math.cos(E[q]);L[q]=k[q]*Math.cos(E[q]);H[q]=k[q]*Math.sin(E[q]);y[q]=k[q]*Math.sin(E[q]);for(d=0;d<q;d++){g=c-d;var N=parseInt(d/t);var R=0==N?N:511-N;var V=0==fa?0==d%2?ia[S+2*d+1]:ia[S+2*(d-1)]:0==d%2?ka[S+2*d+1]:ka[S+2*(d-1)];var X=2<e?0==fa?0==d%2?ia[F+2*d+1]:ia[F+2*(d-1)]:0==d%2?ka[F+2*d+1]:ka[F+2*(d-1)]:V;if(0==N){if(X=N=k[d],R=V=E[d],0<d){var z=ca=k[g];var ha=r=E[g]}}else if(254<=V&&254<=X)X=N=k[d],
R=V=E[d],z=ca=k[g],ha=r=E[g];else{253<V?V=X:253<X&&(X=V);z=this.opposit(V);V=C[V][f][u];var M=this.opposit(X);X=C[X][f][u];0<J&&(ca=this.initCoord(V),v=this.polar(na,ca),ca=this.initCoord(X),p=this.polar(na,ca),2==J&&(v*=v,p*=p));z=0==f?C[z][f][u]:C[z][72-f][u];M=0==f?C[M][f][u]:C[M][72-f][u];var I=512*V+N;ha=512*V+R;var l=Y[I]*v/2048;var K=512*X+N;var O=512*X+R;l+=Y[K]*p/2048;l/=2;X=k[d]*l;l=D[I]/1E4;l+=D[K]/1E4;l/=2;31415<Math.abs(D[I]-D[K])&&(l=0>l?l+Math.PI:l-Math.PI);V=E[d]+l;l=Y[ha]*v/2048;
l+=Y[O]*p/2048;l/=2;ca=k[g]*l;l=D[ha]/1E4;l+=D[O]/1E4;l/=2;31415<Math.abs(D[ha]-D[O])&&(l=0>l?l+Math.PI:l-Math.PI);r=E[g]+l;I=512*z+N;ha=512*z+R;l=Y[I]*v/2048;K=512*M+N;O=512*M+R;l+=Y[K]*p/2048;l/=2;N=k[d]*l;l=D[I]/1E4;l+=D[K]/1E4;l/=2;31415<Math.abs(D[I]-D[K])&&(l=0>l?l+Math.PI:l-Math.PI);R=E[d]+l;l=Y[ha]*v/2048;l+=Y[O]*p/2048;l/=2;z=k[g]*l;l=D[ha]/1E4;l+=D[O]/1E4;l/=2;31415<Math.abs(D[ha]-D[O])&&(l=0>l?l+Math.PI:l-Math.PI);ha=E[g]+l}n[d]=N*Math.cos(R);L[d]=X*Math.cos(V);H[d]=N*Math.sin(R);y[d]=
X*Math.sin(V);0<d&&(n[g]=z*Math.cos(ha),L[g]=ca*Math.cos(r),H[g]=z*Math.sin(ha),y[g]=ca*Math.sin(r))}d={real:n,image:H};this.fastFt(d,!0);d={real:L,image:y};this.fastFt(d,!0);for(d=0;d<c;d++)n[d]*=ma[d],L[d]*=ma[d],T[d]+=n[d],P[d]+=L[d];for(d=0;d<U;d++){k=T[d+1]/32768;E=P[d+1]/32768;g=T[d]/32768;S=P[d]/32768;for(F=la/W;currenttime<F;)R=(F-currenttime)*W,N=g*R+k*(1-R),R=S*R+E*(1-R),da<h?(x[da]=N,a[da]=R,ga++,currenttime=ga/m):(va[da-h]=N,ba[da-h]=R,currenttime+=B),da++,ja++;la++}d=T.subarray(U);T=
new Float32Array(w);T.set(d,0);d=P.subarray(U);P=new Float32Array(w);P.set(d,0);Z+U>=(0==fa?A.length/2:ea.length/2)?xa?(Q=G,this.play()):(Z=0,fa=0==fa&&ea?1:0):Z+=U}};Sopa.prototype.fastFt=function(a,c){var b,e,f,m,n=w;var h=2*Math.PI;var r=a.real,v=a.image;if(!c)for(b=0;b<n;b++){v[b]=0;var p=(1-Math.cos(h*b/n))/2;r[b]*=p}b=Math.PI;for(h=p=0;h<n-1;h++){if(h<=p){var t=r[h];r[h]=r[p];r[p]=t;t=v[h];v[h]=v[p];v[p]=t}for(e=n/2;e<=p;)p-=e,e/=2;p+=e}var u=1;for(p=c?1:-1;u<=n/2;){var y=Math.cos(b);var z=
Math.sin(p*b);h=1;for(f=e=0;f<u;f++){for(m=f;m<n;m+=2*u){var x=m+u;t=r[x]*h-v[x]*e;var A=v[x]*h+r[x]*e;r[x]=r[m]-t;v[x]=v[m]-A;r[m]+=t;v[m]+=A}t=y*h-z*e;e=z*h+y*e;h=t}u*=2;b/=2}if(!c)for(b=0;b<n;b++)r[b]/=n,v[b]/=n,p=Math.sqrt(r[b]*r[b]+v[b]*v[b]),h=Math.atan2(v[b],r[b]),r[b]=p,v[b]=h};Sopa.prototype.initCoord=function(a){var c=Array(3),b=Math.PI/12;127<=a&&(b*=-1);if(0==a)c[0]=c[2]=0,c[1]=1;else if(253==a)c[0]=c[2]=0,c[1]=-1;else{if(9>a||245<=a){var e=Math.PI/4;var f=Math.cos(5*b);9>a?(c[1]=Math.sin(5*
b),a=e*(a-1)-Math.PI):(c[1]=Math.sin(-5*b),a=e*(252-a))}else 25>a||229<=a?(e=Math.PI/8,f=Math.cos(4*b),25>a?(c[1]=Math.sin(4*b),a=e*(a-9)-Math.PI):(c[1]=Math.sin(-4*b),a=e*(244-a))):49>a||205<=a?(e=Math.PI/12,f=Math.cos(3*b),49>a?(c[1]=Math.sin(3*b),a=e*(a-25)-Math.PI):(c[1]=Math.sin(-3*b),a=e*(228-a))):79>a||175<=a?(e=Math.PI/15,f=Math.cos(2*b),79>a?(c[1]=Math.sin(2*b),a=e*(a-49)-Math.PI):(c[1]=Math.sin(-2*b),a=e*(204-a))):111>a||143<=a?(e=Math.PI/16,f=Math.cos(b),111>a?(c[1]=Math.sin(b),a=e*(a-
79)-Math.PI):(c[1]=Math.sin(-b),a=e*(174-a))):(e=Math.PI/16,f=1,c[1]=0,a=127>a?e*(a-111)-Math.PI:e*(142-a));c[0]=f*Math.sin(a);c[2]=f*Math.cos(a)}return c};Sopa.prototype.opposit=function(a){return 0==a||253<=a?a:9>a?1==a?a:10-a:25>a?9==a?a:34-a:49>a?25==a?a:74-a:79>a?49==a?a:128-a:111>a?79==a?a:190-a:127>a?111==a?a:15+a:143>a?142==a?a:a-15:175>a?174==a?a:316-a:205>a?204==a?a:378-a:229>a?228==a?a:432-a:245>a?244==a?a:472-a:252==a?a:496-a};Sopa.prototype.modifySector=function(a,c,b){var e=0;if(253<
a)return a;0!=a&&253!=a&&(e=Math.atan2(oa[a][0],oa[a][2])+c);var f=0==a||253==a?0:9>a||245<=a?Math.cos(5*Math.PI/12):25>a||229<=a?Math.cos(Math.PI/3):49>a||205<=a?Math.cos(Math.PI/4):79>a||175<=a?Math.cos(Math.PI/6):111>a||143<=a?Math.cos(Math.PI/12):1;c=[];c[0]=f*Math.sin(e);c[2]=f*Math.cos(e);c[1]=oa[a][1];0!=b&&0!=c[2]&&(a=c[1],e=c[2],b=Math.atan2(a,e)+b,a=Math.sqrt(e*e+a*a),c[2]=a*Math.cos(b),c[1]=a*Math.sin(b));return this.calcSector(c)};Sopa.prototype.calcSector=function(a){var c=2*Math.PI;
if(a[1]>=Math.sin(11*Math.PI/24))return 0;if(a[1]<=-Math.sin(11*Math.PI/24))return 253;var b=Math.atan2(a[0],a[2]);a[1]>=Math.sin(3*Math.PI/8)?(0>b&&(b+=c),a=1+b/(Math.PI/4)):a[1]<=-Math.sin(3*Math.PI/8)?a=249-b/(Math.PI/4):a[1]>=Math.sin(7*Math.PI/24)?(0>b&&(b+=c),a=9+b/(Math.PI/8)):a[1]<=-Math.sin(7*Math.PI/24)?a=237-b/(Math.PI/8):a[1]>=Math.sin(5*Math.PI/24)?(0>b&&(b+=c),a=25+b/(Math.PI/12)):a[1]<=-Math.sin(5*Math.PI/24)?a=217-b/(Math.PI/12):a[1]>=Math.sin(Math.PI/8)?(0>b&&(b+=c),a=49+b/(Math.PI/
15)):a[1]<=-Math.sin(Math.PI/8)?a=190-b/(Math.PI/15):a[1]>=Math.sin(Math.PI/24)?(0>b&&(b+=c),a=79+b/(Math.PI/16)):a=a[1]<=-Math.sin(Math.PI/24)?159-b/(Math.PI/16):0>b?127-b/(Math.PI/16):b==Math.PI?142:111+b/(Math.PI/16);return a};Sopa.prototype.polar=function(a,c){return(1+Math.cos(Math.acos(c[0]*a[0]+c[1]*a[1]+c[2]*a[2])))/2}};